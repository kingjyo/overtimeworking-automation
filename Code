// ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜ - ìë™ìœ¼ë¡œ í˜„ì¬ì™€ ê°€ì¥ ê°€ê¹Œìš´ ì‹œíŠ¸ë¥¼ ì°¾ì•„ì„œ ë¶„ì„
function runMonthlyClosing() {
  console.log('===== ì›”ë§ ë§ˆê° ë¶„ì„ ì‹œì‘ =====');
  console.log(`ì‹¤í–‰ ì‹œê°„: ${new Date().toLocaleString()}`);
  
  // ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸
  try {
    console.log(`ì‚¬ìš© ê°€ëŠ¥í•œ ì‹¤í–‰ ì‹œê°„: ${(6 * 60 * 1000 - (new Date().getTime() - startTime)) / 1000}ì´ˆ`);
  } catch (e) {
    // startTimeì´ ì—†ì„ ê²½ìš° ë¬´ì‹œ
  }
  
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const allSheets = ss.getSheets();
  
  // ì¶•ì‚°ê³¼ ìƒìˆ˜ ì‹œíŠ¸ë¥¼ ë¶„ë¦¬í•˜ì—¬ ì°¾ê¸°
  const livestockSheets = [];
  const waterSheets = [];
  
  console.log('ì‹œíŠ¸ ê²€ìƒ‰ ì¤‘...');
  console.log(`ì „ì²´ ì‹œíŠ¸ ê°œìˆ˜: ${allSheets.length}`);
  
  allSheets.forEach(sheet => {
    const sheetName = sheet.getName();
    console.log(`ì‹œíŠ¸ í™•ì¸: ${sheetName}`);
    const match = sheetName.match(/^(\d{4})ë…„\s*(\d{1,2})ì›”\s*\((ì¶•ì‚°|ìƒìˆ˜)\)$/);
    
    if (match) {
      const sheetInfo = {
        name: sheetName,
        sheet: sheet,
        year: parseInt(match[1]),
        month: parseInt(match[2]),
        type: match[3],
        date: new Date(parseInt(match[1]), parseInt(match[2]) - 1)
      };
      
      console.log(`ë°œê²¬: ${sheetName} (${match[3]})`);
      
      if (match[3] === 'ì¶•ì‚°') {
        livestockSheets.push(sheetInfo);
      } else if (match[3] === 'ìƒìˆ˜') {
        waterSheets.push(sheetInfo);
      }
    }
  });
  
  console.log(`ì¶•ì‚° ì‹œíŠ¸: ${livestockSheets.length}ê°œ`);
  console.log(`ìƒìˆ˜ ì‹œíŠ¸: ${waterSheets.length}ê°œ`);
  
  // ì²˜ë¦¬í•  ë°ì´í„° ì €ì¥
  const processedData = {};
  
  // ì¶•ì‚° ì‹œíŠ¸ ì²˜ë¦¬
  if (livestockSheets.length > 0) {
    console.log('\n=== ì¶•ì‚° ì‹œíŠ¸ ì²˜ë¦¬ ì‹œì‘ ===');
    try {
      const livestockResult = processSheetsByType(livestockSheets, 'ì¶•ì‚°');
      Object.assign(processedData, livestockResult);
    } catch (error) {
      console.error('ì¶•ì‚° ì‹œíŠ¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error.toString());
      console.error('ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:', error.stack);
      
      // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
      if (error.message.includes('Service invoked too many times')) {
        console.error('API í˜¸ì¶œ í•œë„ ì´ˆê³¼ - ì‘ì—…ì„ ë‚˜ëˆ„ì–´ ì‹¤í–‰í•˜ì„¸ìš”');
      }
    }
  }
  
  // ìƒìˆ˜ ì‹œíŠ¸ ì²˜ë¦¬
  if (waterSheets.length > 0) {
    console.log('\n=== ìƒìˆ˜ ì‹œíŠ¸ ì²˜ë¦¬ ì‹œì‘ ===');
    try {
      const waterResult = processSheetsByType(waterSheets, 'ìƒìˆ˜');
      Object.assign(processedData, waterResult);
    } catch (error) {
      console.error('ìƒìˆ˜ ì‹œíŠ¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error.toString());
      console.error('ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:', error.stack);
    }
  }
  
  // ë¹„êµ ë¶„ì„ ë° ìµœì¢… ë¦¬í¬íŠ¸ ìƒì„±
  if (Object.keys(processedData).length >= 2) {
    console.log('\n=== ë¹„êµ ë¦¬í¬íŠ¸ ìƒì„± ===');
    createComparisonReport(processedData);
    
    // ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸ ì¶”ê°€
    console.log('\n=== ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸ ===');
    try {
      updateSummaryTable(processedData);
      console.log('ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    } catch (error) {
      console.error('ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜:', error.toString());
    }
    
    // ëª¨ë“  ë¶„ì„ ì™„ë£Œ í›„ ì›ë³¸ ë°ì´í„° ì •ë¦¬
    console.log('\n=== ì›ë³¸ ë°ì´í„° ì •ë¦¬ ===');
    Object.keys(processedData).forEach(sheetName => {
      const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      if (sheet) {
        cleanupOriginalData(sheet);
      }
    });
    
    console.log('\n===== ì›”ë§ ë§ˆê° ë¶„ì„ ì™„ë£Œ =====');
    SpreadsheetApp.getUi().alert('ë¶„ì„ ì™„ë£Œ', 'ì›”ë§ ë§ˆê° ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', SpreadsheetApp.getUi().ButtonSet.OK);
  } else {
    console.error('ë¶„ì„í•  ìˆ˜ ìˆëŠ” ì‹œíŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');
    SpreadsheetApp.getUi().alert('ë¶„ì„í•  ìˆ˜ ìˆëŠ” ì‹œíŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');
  }
}

// ì „ì—­ ì‹œì‘ ì‹œê°„ ê¸°ë¡
const startTime = new Date().getTime();

// ì „ì²´ ì›”ë§ ë§ˆê° í”„ë¡œì„¸ìŠ¤ í…ŒìŠ¤íŠ¸ (ì¶•ì‚° + ìƒìˆ˜ ëª¨ë‘)
function testFullMonthlyClosingProcess() {
  console.log('ğŸš€ ===== ì „ì²´ ì›”ë§ ë§ˆê° í”„ë¡œì„¸ìŠ¤ í…ŒìŠ¤íŠ¸ ì‹œì‘ =====');
  console.log(`í…ŒìŠ¤íŠ¸ ì‹œì‘ ì‹œê°„: ${new Date().toLocaleString()}`);
  
  const testStartTime = new Date().getTime();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const allSheets = ss.getSheets();
  
  // ì¶•ì‚°ê³¼ ìƒìˆ˜ ì‹œíŠ¸ ë¶„ë¥˜
  const livestockSheets = [];
  const waterSheets = [];
  
  console.log('\nğŸ“‹ ì‹œíŠ¸ ê²€ìƒ‰ ë° ë¶„ë¥˜...');
  
  allSheets.forEach(sheet => {
    const sheetName = sheet.getName();
    const match = sheetName.match(/^(\d{4})ë…„\s*(\d{1,2})ì›”\s*\((ì¶•ì‚°|ìƒìˆ˜)\)$/);
    
    if (match) {
      const sheetInfo = {
        name: sheetName,
        sheet: sheet,
        year: parseInt(match[1]),
        month: parseInt(match[2]),
        type: match[3],
        date: new Date(parseInt(match[1]), parseInt(match[2]) - 1)
      };
      
      console.log(`âœ“ ë°œê²¬: ${sheetName}`);
      
      if (match[3] === 'ì¶•ì‚°') {
        livestockSheets.push(sheetInfo);
      } else if (match[3] === 'ìƒìˆ˜') {
        waterSheets.push(sheetInfo);
      }
    }
  });
  
  console.log(`\nğŸ“Š ì‹œíŠ¸ í˜„í™©:`);
  console.log(`- ì¶•ì‚° ì‹œíŠ¸: ${livestockSheets.length}ê°œ`);
  console.log(`- ìƒìˆ˜ ì‹œíŠ¸: ${waterSheets.length}ê°œ`);
  
  const processedData = {};
  const processSummary = {
    ì¶•ì‚°: { success: false, sheets: [], errors: [] },
    ìƒìˆ˜: { success: false, sheets: [], errors: [] }
  };
  
  // 1. ì¶•ì‚° ì‹œíŠ¸ ì²˜ë¦¬
  if (livestockSheets.length > 0) {
    console.log(`\n${'='.repeat(60)}`);
    console.log('ğŸ„ === ì¶•ì‚° ë¶€ë¬¸ ì²˜ë¦¬ ì‹œì‘ ===');
    console.log(`${'='.repeat(60)}`);
    
    try {
      const result = testProcessSheetsByType(livestockSheets, 'ì¶•ì‚°');
      Object.assign(processedData, result.data);
      processSummary.ì¶•ì‚° = result.summary;
    } catch (error) {
      console.error('âŒ ì¶•ì‚° ì‹œíŠ¸ ì²˜ë¦¬ ì¤‘ ì „ì²´ ì˜¤ë¥˜:', error.toString());
      processSummary.ì¶•ì‚°.errors.push(error.toString());
    }
  }
  
  // 2. ìƒìˆ˜ ì‹œíŠ¸ ì²˜ë¦¬
  if (waterSheets.length > 0) {
    console.log(`\n${'='.repeat(60)}`);
    console.log('ğŸ’§ === ìƒìˆ˜ ë¶€ë¬¸ ì²˜ë¦¬ ì‹œì‘ ===');
    console.log(`${'='.repeat(60)}`);
    
    try {
      const result = testProcessSheetsByType(waterSheets, 'ìƒìˆ˜');
      Object.assign(processedData, result.data);
      processSummary.ìƒìˆ˜ = result.summary;
    } catch (error) {
      console.error('âŒ ìƒìˆ˜ ì‹œíŠ¸ ì²˜ë¦¬ ì¤‘ ì „ì²´ ì˜¤ë¥˜:', error.toString());
      processSummary.ìƒìˆ˜.errors.push(error.toString());
    }
  }
  
  // 3. ë¹„êµ ë¦¬í¬íŠ¸ ìƒì„±
  console.log(`\n${'='.repeat(60)}`);
  console.log('ğŸ“Š === ë¹„êµ ë¦¬í¬íŠ¸ ìƒì„± ===');
  console.log(`${'='.repeat(60)}`);
  
  if (Object.keys(processedData).length >= 2) {
    try {
      createComparisonReport(processedData);
      console.log('âœ… ë¹„êµ ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ');
      
      // ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸ ì¶”ê°€
      updateSummaryTable(processedData);
      console.log('âœ… ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    } catch (error) {
      console.error('âŒ ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨:', error.toString());
    }
  } else {
    console.error('âš ï¸  ë¹„êµí•  ìˆ˜ ìˆëŠ” ì‹œíŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');
  }
  
  // 4. ìµœì¢… ê²°ê³¼ ìš”ì•½
  const totalDuration = (new Date().getTime() - testStartTime) / 1000;
  
  console.log(`\n${'='.repeat(60)}`);
  console.log('ğŸ“‹ === ì „ì²´ í”„ë¡œì„¸ìŠ¤ ê²°ê³¼ ìš”ì•½ ===');
  console.log(`${'='.repeat(60)}`);
  
  console.log('\nğŸ„ ì¶•ì‚° ë¶€ë¬¸:');
  if (processSummary.ì¶•ì‚°.sheets.length > 0) {
    console.log(`  âœ… ì²˜ë¦¬ëœ ì‹œíŠ¸: ${processSummary.ì¶•ì‚°.sheets.join(', ')}`);
  }
  if (processSummary.ì¶•ì‚°.errors.length > 0) {
    console.log(`  âŒ ì˜¤ë¥˜: ${processSummary.ì¶•ì‚°.errors.length}ê±´`);
  }
  
  console.log('\nğŸ’§ ìƒìˆ˜ ë¶€ë¬¸:');
  if (processSummary.ìƒìˆ˜.sheets.length > 0) {
    console.log(`  âœ… ì²˜ë¦¬ëœ ì‹œíŠ¸: ${processSummary.ìƒìˆ˜.sheets.join(', ')}`);
  }
  if (processSummary.ìƒìˆ˜.errors.length > 0) {
    console.log(`  âŒ ì˜¤ë¥˜: ${processSummary.ìƒìˆ˜.errors.length}ê±´`);
  }
  
  console.log(`\nâ±ï¸  ì´ ì†Œìš”ì‹œê°„: ${totalDuration}ì´ˆ`);
  console.log('\nğŸ ===== ì „ì²´ ì›”ë§ ë§ˆê° í”„ë¡œì„¸ìŠ¤ í…ŒìŠ¤íŠ¸ ì¢…ë£Œ =====');
}

// íƒ€ì…ë³„ ì‹œíŠ¸ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸ (ìƒì„¸ ë¡œê·¸ í¬í•¨)
function testProcessSheetsByType(sheets, type) {
  if (sheets.length === 0) return { data: {}, summary: { success: true, sheets: [], errors: [] } };
  
  const summary = { success: true, sheets: [], errors: [] };
  
  // ë‚ ì§œ ìˆœìœ¼ë¡œ ì •ë ¬ (ìµœì‹ ìˆœ)
  sheets.sort((a, b) => b.date - a.date);
  
  // í˜„ì¬ ë‚ ì§œì™€ ê°€ì¥ ê°€ê¹Œìš´ ì‹œíŠ¸ ì°¾ê¸°
  const now = new Date();
  const currentSheet = sheets.find(s => s.date <= now) || sheets[0];
  
  console.log(`\nğŸ“Œ ${type} ê¸°ì¤€ ì‹œíŠ¸: ${currentSheet.name}`);
  
  // ì „ì›” ì‹œíŠ¸ ì°¾ê¸°
  const prevMonthSheet = findPreviousMonthSheet(sheets, currentSheet);
  
  // ì‘ë…„ ë™ì›” ì‹œíŠ¸ ì°¾ê¸°
  const prevYearSheet = findPreviousYearSheet(sheets, currentSheet);
  
  // ì°¾ì€ ì‹œíŠ¸ë“¤ ì²˜ë¦¬
  const processedData = {};
  const sheetsToProcess = [];
  
  // ì²˜ë¦¬í•  ì‹œíŠ¸ ëª©ë¡
  sheetsToProcess.push({ sheet: currentSheet, label: 'í˜„ì¬' });
  if (prevMonthSheet) sheetsToProcess.push({ sheet: prevMonthSheet, label: 'ì „ì›”' });
  if (prevYearSheet) sheetsToProcess.push({ sheet: prevYearSheet, label: 'ì‘ë…„ë™ì›”' });
  
  console.log(`\nì²˜ë¦¬í•  ${type} ì‹œíŠ¸:`);
  sheetsToProcess.forEach(item => {
    console.log(`  - ${item.label}: ${item.sheet.name}`);
  });
  
  // ê° ì‹œíŠ¸ ì²˜ë¦¬
  sheetsToProcess.forEach((item, index) => {
    console.log(`\n${'â”€'.repeat(50)}`);
    console.log(`ğŸ“„ ${type} - ${item.label} ì‹œíŠ¸ ì²˜ë¦¬: ${item.sheet.name}`);
    console.log(`${'â”€'.repeat(50)}`);
    
    try {
      const result = testProcessSingleSheet(item.sheet.sheet);
      processedData[item.sheet.name] = result;
      summary.sheets.push(item.sheet.name);
      console.log(`âœ… ${item.sheet.name} ì²˜ë¦¬ ì™„ë£Œ`);
    } catch (error) {
      console.error(`âŒ ${item.sheet.name} ì²˜ë¦¬ ì‹¤íŒ¨:`, error.toString());
      summary.errors.push(`${item.sheet.name}: ${error.toString()}`);
      summary.success = false;
    }
  });
  
  return { data: processedData, summary: summary };
}

// ë‹¨ì¼ ì‹œíŠ¸ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸ (8ë‹¨ê³„ í¬í•¨)
function testProcessSingleSheet(sheet) {
  const sheetName = sheet.getName();
  const steps = [
    { num: 1, name: 'í—¤ë” ìˆ˜ì •', func: modifyHeaders },
    { num: 2, name: 'ë³‘í•©ëœ ì…€ í•´ì œ', func: unmergeAllCells },
    { num: 3, name: 'ë¶ˆí•„ìš”í•œ ì…€ ì‚­ì œ', func: deleteUnnecessaryCells },
    { num: 4, name: 'AG, AH ì—´ ì‚½ì…', func: insertReasonColumns },
    { num: 5, name: 'Uì—´ ì‹œê°„ í˜•ì‹ ë³€í™˜', func: convertTimeFormat },
    { num: 6, name: 'AFì—´ ì‹ ì²­ì‚¬ìœ  ì •ë¦¬', func: standardizeAndSplitReasons },
    { num: 7, name: 'ì›ë³¸ ë°ì´í„° í…Œë‘ë¦¬ ì¶”ê°€', func: addBorderToOriginalData },
    { num: 8, name: 'ì‚¬ìœ ë³„ ì‹œê°„ ë¶„ë°° ë° ì§‘ê³„', func: distributeAndSummarize }
  ];
  
  let result = null;
  
  for (const step of steps) {
    console.log(`  ${step.num}ë‹¨ê³„: ${step.name}...`, '');
    try {
      if (step.num === 8) {
        result = step.func(sheet);
      } else {
        step.func(sheet);
      }
      console.log(' âœ“');
    } catch (error) {
      console.log(' âœ—');
      throw new Error(`${step.num}ë‹¨ê³„(${step.name}) ì‹¤íŒ¨: ${error.toString()}`);
    }
  }
  
  return result;
}

// íŠ¹ì • íƒ€ì…ì˜ ì‹œíŠ¸ë“¤ì„ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
function processSheetsByType(sheets, type) {
  if (sheets.length === 0) return {};
  
  // ë‚ ì§œ ìˆœìœ¼ë¡œ ì •ë ¬ (ìµœì‹ ìˆœ)
  sheets.sort((a, b) => b.date - a.date);
  
  // í˜„ì¬ ë‚ ì§œì™€ ê°€ì¥ ê°€ê¹Œìš´ ì‹œíŠ¸ ì°¾ê¸°
  const now = new Date();
  const currentSheet = sheets.find(s => s.date <= now) || sheets[0];
  
  console.log(`${type} - ê¸°ì¤€ ì‹œíŠ¸: ${currentSheet.name}`);
  
  // ì „ì›” ì‹œíŠ¸ ì°¾ê¸°
  const prevMonthSheet = findPreviousMonthSheet(sheets, currentSheet);
  
  // ì‘ë…„ ë™ì›” ì‹œíŠ¸ ì°¾ê¸°
  const prevYearSheet = findPreviousYearSheet(sheets, currentSheet);
  
  // ì°¾ì€ ì‹œíŠ¸ë“¤ ì²˜ë¦¬
  const processedData = {};
  
  // í˜„ì¬ ì‹œíŠ¸ ì²˜ë¦¬
  processedData[currentSheet.name] = processSheet(currentSheet.sheet);
  
  // ì „ì›” ì‹œíŠ¸ ì²˜ë¦¬
  if (prevMonthSheet) {
    console.log(`${type} - ì „ì›” ì‹œíŠ¸: ${prevMonthSheet.name}`);
    processedData[prevMonthSheet.name] = processSheet(prevMonthSheet.sheet);
  }
  
  // ì‘ë…„ ë™ì›” ì‹œíŠ¸ ì²˜ë¦¬
  if (prevYearSheet) {
    console.log(`${type} - ì‘ë…„ ë™ì›” ì‹œíŠ¸: ${prevYearSheet.name}`);
    processedData[prevYearSheet.name] = processSheet(prevYearSheet.sheet);
  }
  
  return processedData;
}

// ì „ì›” ì‹œíŠ¸ ì°¾ê¸°
function findPreviousMonthSheet(sheets, currentSheet) {
  let targetYear = currentSheet.year;
  let targetMonth = currentSheet.month - 1;
  
  if (targetMonth === 0) {
    targetMonth = 12;
    targetYear--;
  }
  
  return sheets.find(s => s.year === targetYear && s.month === targetMonth);
}

// ì‘ë…„ ë™ì›” ì‹œíŠ¸ ì°¾ê¸°
function findPreviousYearSheet(sheets, currentSheet) {
  const targetYear = currentSheet.year - 1;
  const targetMonth = currentSheet.month;
  
  return sheets.find(s => s.year === targetYear && s.month === targetMonth);
}

// ê°œë³„ ì‹œíŠ¸ ì²˜ë¦¬ í•¨ìˆ˜
function processSheet(sheet) {
  const sheetName = sheet.getName();
  console.log(`=== ${sheetName} ì‹œíŠ¸ ì²˜ë¦¬ ì‹œì‘ ===`);
  
  try {
    // 1. í—¤ë” ìˆ˜ì • - "ì‹ ì²­", "ë³€ê²½ìŠ¤ì¼€ì¤„", "ê²°ê³¼" ì¶”ê°€
    console.log(`${sheetName}: 1. í—¤ë” ìˆ˜ì • ì¤‘...`);
    modifyHeaders(sheet);
    
    // 2. ë³‘í•©ëœ ì…€ í•´ì œ
    console.log(`${sheetName}: 2. ë³‘í•©ëœ ì…€ í•´ì œ ì¤‘...`);
    unmergeAllCells(sheet);
    
    // 3. ë¶ˆí•„ìš”í•œ ì…€ ì‚­ì œ (ì…€ì„ ì‚­ì œí•˜ê³  ìœ„ë¡œ ì´ë™)
    console.log(`${sheetName}: 3. ë¶ˆí•„ìš”í•œ ì…€ ì‚­ì œ ì¤‘...`);
    deleteUnnecessaryCells(sheet);
    
    // 4. AG, AH ì—´ ì‚½ì… (ìˆ˜ì •ì ì—´ ì•ì—)
    console.log(`${sheetName}: 4. AG, AH ì—´ ì‚½ì… ì¤‘...`);
    insertReasonColumns(sheet);
    
    // 5. Uì—´ ì‹œê°„ í˜•ì‹ ë³€í™˜
    console.log(`${sheetName}: 5. Uì—´ ì‹œê°„ í˜•ì‹ ë³€í™˜ ì¤‘...`);
    convertTimeFormat(sheet);
    
    // 6. AFì—´ ì‹ ì²­ì‚¬ìœ  ì •ë¦¬ ë° AG, AHì—´ì— ë¶„ë¦¬
    console.log(`${sheetName}: 6. AFì—´ ì‹ ì²­ì‚¬ìœ  ì •ë¦¬ ì¤‘...`);
    standardizeAndSplitReasons(sheet);
    
    // 7. ì›ë³¸ ë°ì´í„° í…Œë‘ë¦¬ ì¶”ê°€
    console.log(`${sheetName}: 7. ì›ë³¸ ë°ì´í„° í…Œë‘ë¦¬ ì¶”ê°€ ì¤‘...`);
    addBorderToOriginalData(sheet);
    
    // 8. ì‚¬ìœ ë³„ ì‹œê°„ ë¶„ë°° ë° ì§‘ê³„
    console.log(`${sheetName}: 8. ì‚¬ìœ ë³„ ì‹œê°„ ë¶„ë°° ë° ì§‘ê³„ ì¤‘...`);
    const summary = distributeAndSummarize(sheet);
    
    console.log(`${sheetName}: ì²˜ë¦¬ ì™„ë£Œ!`);
    console.log(`${sheetName}: ì§‘ê³„ ê²°ê³¼:`, JSON.stringify(summary));
    
    return summary;
    
  } catch (error) {
    console.error(`${sheetName}: ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ!`);
    console.error(`ì˜¤ë¥˜ ë‚´ìš©: ${error.toString()}`);
    console.error(`ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤: ${error.stack}`);
    throw error;
  }
}

// 1. í—¤ë” ìˆ˜ì • í•¨ìˆ˜
function modifyHeaders(sheet) {
  const sheetName = sheet.getName();
  console.log(`${sheetName}: í—¤ë” ìˆ˜ì • ì‹œì‘`);
  
  try {
    // E2:L2ì— "ì‹ ì²­" ì¶”ê°€
    console.log(`${sheetName}: E2:L2 ë²”ìœ„ ìˆ˜ì • ì‹œì‘`);
    for (let col = 5; col <= 12; col++) {
      console.log(`${sheetName}: ì—´ ${col} ì½ê¸° ì‹œë„`);
      const value = sheet.getRange(2, col).getValue();
      console.log(`${sheetName}: ì—´ ${col} ê°’: "${value}"`);
      if (value) {
        sheet.getRange(2, col).setValue("ì‹ ì²­ " + value);
      }
    }
    
    // O2:P2ì— "ë³€ê²½ìŠ¤ì¼€ì¤„" ì¶”ê°€
    console.log(`${sheetName}: O2:P2 ë²”ìœ„ ìˆ˜ì • ì‹œì‘`);
    for (let col = 15; col <= 16; col++) {
      console.log(`${sheetName}: ì—´ ${col} ì½ê¸° ì‹œë„`);
      const value = sheet.getRange(2, col).getValue();
      console.log(`${sheetName}: ì—´ ${col} ê°’: "${value}"`);
      if (value) {
        sheet.getRange(2, col).setValue("ë³€ê²½ìŠ¤ì¼€ì¤„ " + value);
      }
    }
    
    // S2, T2ì— "ê²°ê³¼" ì¶”ê°€
    console.log(`${sheetName}: S2, T2 ìˆ˜ì • ì‹œì‘`);
    const sValue = sheet.getRange(2, 19).getValue();
    console.log(`${sheetName}: S2 ê°’: "${sValue}"`);
    const tValue = sheet.getRange(2, 20).getValue();
    console.log(`${sheetName}: T2 ê°’: "${tValue}"`);
    if (sValue) sheet.getRange(2, 19).setValue("ê²°ê³¼ " + sValue);
    if (tValue) sheet.getRange(2, 20).setValue("ê²°ê³¼ " + tValue);
    
    console.log(`${sheetName}: í—¤ë” ìˆ˜ì • ì™„ë£Œ`);
    
  } catch (error) {
    console.error(`${sheetName}: í—¤ë” ìˆ˜ì • ì¤‘ ì˜¤ë¥˜: ${error.toString()}`);
    throw error;
  }
}

// 2. ë³‘í•©ëœ ì…€ í•´ì œ
function unmergeAllCells(sheet) {
  const sheetName = sheet.getName();
  console.log(`${sheetName}: ë³‘í•©ëœ ì…€ í•´ì œ ì‹œì‘`);
  
  try {
    // ì‘ì€ ë²”ìœ„ë¶€í„° ì‹œì‘í•˜ì—¬ ì ì§„ì ìœ¼ë¡œ í™•ëŒ€
    const ranges = [
      "A1:AI10",   // ë¨¼ì € ìƒë‹¨ 10í–‰
      "A11:AI20",  // ë‹¤ìŒ 10í–‰
      "A1:AI50"    // ìƒë‹¨ 50í–‰ ì „ì²´
    ];
    
    for (const rangeStr of ranges) {
      try {
        console.log(`${sheetName}: ${rangeStr} ë²”ìœ„ ë³‘í•© í•´ì œ ì‹œë„`);
        const range = sheet.getRange(rangeStr);
        range.breakApart();
        console.log(`${sheetName}: ${rangeStr} ë²”ìœ„ ë³‘í•© í•´ì œ ì™„ë£Œ`);
      } catch (e) {
        console.log(`${sheetName}: ${rangeStr} ë²”ìœ„ ë³‘í•© í•´ì œ ì‹¤íŒ¨ (ë¬´ì‹œ)`);
      }
    }
    
    console.log(`${sheetName}: ë³‘í•©ëœ ì…€ í•´ì œ ì™„ë£Œ`);
    
  } catch (error) {
    console.error(`${sheetName}: ë³‘í•© í•´ì œ ì¤‘ ì˜¤ë¥˜: ${error.toString()}`);
    // ì˜¤ë¥˜ê°€ ìˆì–´ë„ ê³„ì† ì§„í–‰
  }
}

// 3. ë¶ˆí•„ìš”í•œ ì…€ ì‚­ì œ - ì…€ì„ ì‚­ì œí•˜ê³  ìœ„ë¡œ ì´ë™
function deleteUnnecessaryCells(sheet) {
  const sheetName = sheet.getName();
  console.log(`${sheetName}: ë¶ˆí•„ìš”í•œ ì…€ ì‚­ì œ ì‹œì‘`);
  
  try {
    // íŠ¹ì • ì…€ë“¤ì„ ì‚­ì œí•˜ê³  ìœ„ë¡œ ì´ë™
    // ìˆœì„œë¥¼ ë’¤ì—ì„œë¶€í„° ì²˜ë¦¬í•´ì•¼ ì¸ë±ìŠ¤ê°€ ê¼¬ì´ì§€ ì•ŠìŒ
    
    console.log(`${sheetName}: AD2:AG2 ì‚­ì œ ì‹œë„`);
    sheet.getRange("AD2:AG2").deleteCells(SpreadsheetApp.Dimension.ROWS);
    SpreadsheetApp.flush(); // ë³€ê²½ì‚¬í•­ ì¦‰ì‹œ ì ìš©
    
    console.log(`${sheetName}: Z1:AC1 ì‚­ì œ ì‹œë„`);
    sheet.getRange("Z1:AC1").deleteCells(SpreadsheetApp.Dimension.ROWS);
    SpreadsheetApp.flush();
    
    console.log(`${sheetName}: U2:Y2 ì‚­ì œ ì‹œë„`);
    sheet.getRange("U2:Y2").deleteCells(SpreadsheetApp.Dimension.ROWS);
    SpreadsheetApp.flush();
    
    console.log(`${sheetName}: S1:T1 ì‚­ì œ ì‹œë„`);
    sheet.getRange("S1:T1").deleteCells(SpreadsheetApp.Dimension.ROWS);
    SpreadsheetApp.flush();
    
    console.log(`${sheetName}: Q2:R2 ì‚­ì œ ì‹œë„`);
    sheet.getRange("Q2:R2").deleteCells(SpreadsheetApp.Dimension.ROWS);
    SpreadsheetApp.flush();
    
    console.log(`${sheetName}: O1:P1 ì‚­ì œ ì‹œë„`);
    sheet.getRange("O1:P1").deleteCells(SpreadsheetApp.Dimension.ROWS);
    SpreadsheetApp.flush();
    
    console.log(`${sheetName}: M2:N2 ì‚­ì œ ì‹œë„`);
    sheet.getRange("M2:N2").deleteCells(SpreadsheetApp.Dimension.ROWS);
    SpreadsheetApp.flush();
    
    console.log(`${sheetName}: E1:L1 ì‚­ì œ ì‹œë„`);
    sheet.getRange("E1:L1").deleteCells(SpreadsheetApp.Dimension.ROWS);
    SpreadsheetApp.flush();
    
    console.log(`${sheetName}: A2:D2 ì‚­ì œ ì‹œë„`);
    sheet.getRange("A2:D2").deleteCells(SpreadsheetApp.Dimension.ROWS);
    SpreadsheetApp.flush();
    
    console.log(`${sheetName}: ë¶ˆí•„ìš”í•œ ì…€ ì‚­ì œ ì™„ë£Œ`);
    
  } catch (error) {
    console.error(`${sheetName}: ì…€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.toString()}`);
    throw error;
  }
}

// 4. AG, AH ì—´ ì‚½ì…
function insertReasonColumns(sheet) {
  // AG ìœ„ì¹˜(33ë²ˆì§¸ ì—´)ì— 2ê°œ ì—´ ì‚½ì…
  sheet.insertColumns(33, 2);
  
  // í—¤ë” ì„¤ì •
  sheet.getRange("AG1").setValue("ì‹ ì²­ì‚¬ìœ 2");
  sheet.getRange("AH1").setValue("ì‹ ì²­ì‚¬ìœ 3");
}

// 5. Uì—´ ì‹œê°„ í˜•ì‹ ë³€í™˜
function convertTimeFormat(sheet) {
  const sheetName = sheet.getName();
  const lastRow = sheet.getLastRow();
  console.log(`${sheetName}: Uì—´ ì‹œê°„ ë³€í™˜ - ë§ˆì§€ë§‰ í–‰: ${lastRow}`);
  
  let convertedCount = 0;
  let errorCount = 0;
  
  for (let row = 2; row <= lastRow; row++) {
    try {
      const timeValue = sheet.getRange(row, 21).getValue(); // Uì—´
      if (timeValue) {
        console.log(`${sheetName}: í–‰ ${row} - ì›ë³¸ ê°’: "${timeValue}" (íƒ€ì…: ${typeof timeValue})`);
        
        if (typeof timeValue === 'string') {
          const converted = convertTimeToMinutes(timeValue);
          sheet.getRange(row, 21).setValue(converted);
          console.log(`${sheetName}: í–‰ ${row} - ë³€í™˜ ì™„ë£Œ: ${converted}ë¶„`);
          convertedCount++;
        } else if (typeof timeValue === 'number') {
          console.log(`${sheetName}: í–‰ ${row} - ì´ë¯¸ ìˆ«ì í˜•ì‹: ${timeValue}`);
        }
      }
    } catch (error) {
      errorCount++;
      console.error(`${sheetName}: í–‰ ${row} ë³€í™˜ ì¤‘ ì˜¤ë¥˜: ${error.toString()}`);
    }
  }
  
  console.log(`${sheetName}: Uì—´ ì‹œê°„ ë³€í™˜ ì™„ë£Œ - ì„±ê³µ: ${convertedCount}, ì˜¤ë¥˜: ${errorCount}`);
}

// ì‹œê°„ ë¬¸ìì—´ì„ ë¶„ìœ¼ë¡œ ë³€í™˜
function convertTimeToMinutes(timeStr) {
  console.log(`ì‹œê°„ ë³€í™˜ ì‹œë„: "${timeStr}"`);
  
  const match = timeStr.match(/(\d+)ì‹œê°„\s*(\d+)ë¶„/);
  if (match) {
    const hours = parseInt(match[1]);
    const minutes = parseInt(match[2]);
    const totalMinutes = hours * 60 + minutes;
    console.log(`ë³€í™˜ ì„±ê³µ: ${hours}ì‹œê°„ ${minutes}ë¶„ = ${totalMinutes}ë¶„`);
    return totalMinutes;
  }
  
  console.warn(`ë³€í™˜ ì‹¤íŒ¨ - íŒ¨í„´ ë¶ˆì¼ì¹˜: "${timeStr}"`);
  return 0;
}

// 6. AFì—´ ì‹ ì²­ì‚¬ìœ  ì •ë¦¬ ë° AG, AHì—´ì— ë¶„ë¦¬
function standardizeAndSplitReasons(sheet) {
  const sheetName = sheet.getName();
  console.log(`${sheetName}: ì‹ ì²­ì‚¬ìœ  í‘œì¤€í™” ì‹œì‘`);
  
  const lastRow = sheet.getLastRow();
  console.log(`${sheetName}: ì²˜ë¦¬í•  í–‰ ìˆ˜: ${lastRow - 1}í–‰ (2í–‰ë¶€í„° ${lastRow}í–‰ê¹Œì§€)`);
  
  let processedCount = 0;
  let errorCount = 0;
  
  for (let row = 2; row <= lastRow; row++) {
    try {
      // 10í–‰ë§ˆë‹¤ ì§„í–‰ ìƒí™© ì¶œë ¥
      if (row % 10 === 0) {
        console.log(`${sheetName}: ì‹ ì²­ì‚¬ìœ  ì²˜ë¦¬ ì§„í–‰ ì¤‘... ${row}/${lastRow}`);
        SpreadsheetApp.flush(); // ë³€ê²½ì‚¬í•­ ì£¼ê¸°ì  ì €ì¥
      }
      
      let reasonStr = sheet.getRange(row, 32).getValue(); // AFì—´
      if (!reasonStr) continue;
      
      console.log(`${sheetName}: í–‰ ${row} - ì›ë³¸ ì‚¬ìœ : "${reasonStr}"`);
      
      // ë¨¼ì € ê° ì‚¬ìœ ë¥¼ ë¶„ë¦¬
      const reasons = splitReasonsAdvanced(reasonStr);
      console.log(`${sheetName}: í–‰ ${row} - ë¶„ë¦¬ëœ ì‚¬ìœ : ${reasons.length}ê°œ`);
      
      // ê° ì‚¬ìœ ë¥¼ í‘œì¤€í™”
      const standardizedReasons = reasons.map(reason => {
        const standardized = standardizeReason(reason);
        if (reason !== standardized) {
          console.log(`${sheetName}: í–‰ ${row} - í‘œì¤€í™”: "${reason}" â†’ "${standardized}"`);
        }
        return standardized;
      });
      
      // AF, AG, AH ì—´ì— ë¶„ë°°
      sheet.getRange(row, 32).setValue(""); // ë¨¼ì € ì´ˆê¸°í™”
      sheet.getRange(row, 33).setValue("");
      sheet.getRange(row, 34).setValue("");
      
      if (standardizedReasons.length > 0) {
        sheet.getRange(row, 32).setValue(standardizedReasons[0]); // AFì—´
      }
      if (standardizedReasons.length > 1) {
        sheet.getRange(row, 33).setValue(standardizedReasons[1]); // AGì—´
      }
      if (standardizedReasons.length > 2) {
        sheet.getRange(row, 34).setValue(standardizedReasons[2]); // AHì—´
      }
      
      processedCount++;
      
    } catch (error) {
      errorCount++;
      console.error(`${sheetName}: í–‰ ${row} ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ${error.toString()}`);
    }
  }
  
  console.log(`${sheetName}: ì‹ ì²­ì‚¬ìœ  í‘œì¤€í™” ì™„ë£Œ - ì²˜ë¦¬: ${processedCount}, ì˜¤ë¥˜: ${errorCount}`);
}

// ê³ ê¸‰ ì‚¬ìœ  ë¶„ë¦¬ í•¨ìˆ˜ - ê´„í˜¸ ì•ˆì˜ "ë°" ì œì™¸
function splitReasonsAdvanced(reasonStr) {
  // ìˆ«ì ì½¤ë§ˆë¥¼ ì ìœ¼ë¡œ ë¨¼ì € ë³€í™˜
  reasonStr = reasonStr.replace(/(\d),(\d+)\s*[Ll]/g, '$1.$2L');
  
  // ê´„í˜¸ ì•ˆì˜ ë‚´ìš©ì„ ì„ì‹œë¡œ ì¹˜í™˜
  const bracketContents = [];
  let processed = reasonStr.replace(/\([^)]*\)/g, (match) => {
    bracketContents.push(match);
    return `BRACKET_${bracketContents.length - 1}`;
  });
  
  // "ì†¡ì•„ì§€ ë¶„ë§Œ ë° ì²˜ì¹˜"ì™€ "ë¶„ë§Œ ë° ì²˜ì¹˜" ë³´í˜¸
  if (processed.includes("ì†¡ì•„ì§€ ë¶„ë§Œ ë° ì²˜ì¹˜")) {
    processed = processed.replace(/ì†¡ì•„ì§€ ë¶„ë§Œ ë° ì²˜ì¹˜/g, "TEMP_SONGAJI");
  }
  if (processed.includes("ë¶„ë§Œ ë° ì²˜ì¹˜")) {
    processed = processed.replace(/ë¶„ë§Œ ë° ì²˜ì¹˜/g, "TEMP_BUNMAN");
  }
  
  // ê´„í˜¸ ë°–ì˜ "ë°"ë§Œ ì½¤ë§ˆë¡œ ë³€ê²½
  processed = processed.replace(/\s*ë°\s*/g, ',');
  
  // ë³´í˜¸í–ˆë˜ ê²ƒë“¤ ë³µì›
  processed = processed.replace(/TEMP_SONGAJI/g, "ì†¡ì•„ì§€ ë¶„ë§Œ ë° ì²˜ì¹˜");
  processed = processed.replace(/TEMP_BUNMAN/g, "ë¶„ë§Œ ë° ì²˜ì¹˜");
  
  // ê´„í˜¸ ë‚´ìš© ë³µì›
  processed = processed.replace(/BRACKET_(\d+)/g, (match, index) => {
    return bracketContents[parseInt(index)];
  });
  
  // ì½¤ë§ˆë¡œ ë¶„ë¦¬
  const splitReasons = processed.split(',').map(r => r.trim()).filter(r => r);
  
  return splitReasons;
}

// ê°œë³„ ì‚¬ìœ  í‘œì¤€í™”
function standardizeReason(reason) {
  // ê´„í˜¸ ë‚´ìš© ì²˜ë¦¬
  const bracketMatch = reason.match(/(.+)\((.+)\)/);
  if (bracketMatch) {
    if (bracketMatch[2].includes('ì¸ê³µì ì¶œ')) {
      return 'ì¸ê³µì ì¶œ';
    } else if (bracketMatch[2].includes('ì‹ ì¶•ì‚¬')) {
      return 'ì‹ ì¶•ì‚¬ ì¶•ìš° ì´ë™';
    } else if (bracketMatch[1].trim().includes('í™˜ì¶•ê´€ë¦¬') || bracketMatch[1].trim().includes('í™˜ì¶• ê´€ë¦¬')) {
      return 'í™˜ì¶• ê´€ë¦¬';
    } else {
      reason = bracketMatch[1].trim();
    }
  }
  
  // ë„ì–´ì“°ê¸° ì •ë¦¬
  reason = reason.trim().replace(/\s+/g, ' ');
  
  // ìƒìˆ˜ ê´€ë ¨ í‘œì¤€í™”
  if (reason.includes('ìƒì‚°') || reason.includes('BTL') || reason.includes('ë³‘') || reason.includes('CAP') || reason.includes('btl')) {
    return standardizeWaterReason(reason);
  }
  
  // ì •ë¹„ ê´€ë ¨
  if (reason.includes('ì •ë¹„')) {
    return 'ìƒì‚°ì„¤ë¹„ ì •ë¹„';
  }
  
  // ì¶•ì‚° í‘œì¤€í™” ë§¤í•‘
  const standardMap = {
    'ì†¡ì•„ì§€ ë¶„ë§Œ ë° ì²˜ì¹˜': ['ì†¡ì•„ì§€ ì²˜ì¹˜', 'ì†¡ì•„ì§€ ë¶„ë§Œ', 'ë¶„ë§Œ ë° ì²˜ì¹˜', 'ë¶„ë§Œë°ì²˜ì¹˜', 'ì†¡ì•„ì§€ ë¶„ë§Œ ë° ì²˜ì¹˜', 'ë¶„ë§Œ ì²˜ì¹˜'],
    'ì¶•ì‚¬ ì†Œë…': ['ì¶•ì‚¬ì†Œë…', 'ì¶•ì‚¬ ì†Œë…'],
    'ì˜ë† ì¥ë¹„ ê¸°ë¦„ ì£¼ìœ ': ['ì˜ë†ì¥ë¹„ ê¸°ë¦„ì£¼ìœ ', 'ì˜ë†ì¥ë¹„ê¸°ë¦„ì£¼ìœ ', 'ì˜ë†ì¥ë¹„ ê¸°ë¦„ ì£¼ìœ ', 'ì˜ë†ì¥ë¹„ ì£¼ìœ ', 'ê¸°ë¦„ì£¼ìœ '],
    'í™˜ì¶• ê´€ë¦¬': ['í™˜ì¶•ê´€ë¦¬', 'í™˜ì¶•ì‚¬ í™˜ì¶•ì†¡ì•„ì§€ ê´€ë¦¬', 'í™˜ì¶• ê´€ë¦¬'],
    'ë°±ì‹  ì ‘ì¢…': ['ëŸ¼í”¼ìŠ¤í‚¨ ì†¡ì•„ì§€ ì ‘ì¢…í›„ ê´€ì°°', 'ì ‘ì¢…'],
    'ì‹ ì¶•ì‚¬ ì¶•ìš° ì´ë™': ['ì¶•ìš°ì´ë™', 'ì¶•ìš° ì´ë™']
  };
  
  // í‘œì¤€í™” ì ìš©
  for (const [standard, variations] of Object.entries(standardMap)) {
    if (variations.some(v => reason.includes(v)) || reason === standard) {
      return standard;
    }
  }
  
  // íŠ¹ë³„ ì¼€ì´ìŠ¤ ì²˜ë¦¬
  if (reason.includes('ì ‘ì¢…')) return 'ë°±ì‹  ì ‘ì¢…';
  if (reason.includes('í™˜ì¶•') && reason.includes('ê´€ë¦¬')) return 'í™˜ì¶• ê´€ë¦¬';
  if (reason.includes('ì˜ë†') && reason.includes('ì£¼ìœ ')) return 'ì˜ë† ì¥ë¹„ ê¸°ë¦„ ì£¼ìœ ';
  if (reason.includes('ë¶„ë§Œ') || reason.includes('ì†¡ì•„ì§€') && (reason.includes('ì²˜ì¹˜') || reason.includes('ë¶„ë§Œ'))) return 'ì†¡ì•„ì§€ ë¶„ë§Œ ë° ì²˜ì¹˜';
  if (reason.includes('ì¶•ì‚¬') && reason.includes('ì†Œë…')) return 'ì¶•ì‚¬ ì†Œë…';
  
  return reason;
}

// ìƒìˆ˜ ì‚¬ìœ  í‘œì¤€í™” í•¨ìˆ˜
function standardizeWaterReason(reason) {
  // ìš©ëŸ‰ í‘œì‹œì—ì„œ ì»´ë§ˆë¥¼ ì ìœ¼ë¡œ ë³€í™˜ (ì˜ˆ: 1,5L â†’ 1.5L)
  reason = reason.replace(/(\d),(\d+)\s*[Ll]/g, '$1.$2L');
  
  // 05L â†’ 0.5L ë³€í™˜
  reason = reason.replace(/05L/g, '0.5L');
  
  // ë„ì–´ì“°ê¸° ì œê±°í•œ ë²„ì „ìœ¼ë¡œ ë¹„êµ
  const noSpaceReason = reason.replace(/\s+/g, '').toLowerCase();
  
  // ë³‘ â†’ BTL ë³€í™˜
  reason = reason.replace(/ë³‘ìƒì‚°/g, 'BTLìƒì‚°');
  reason = reason.replace(/ë³‘ ìƒì‚°/g, 'BTLìƒì‚°');
  
  // btl â†’ BTL ë³€í™˜ (ëŒ€ì†Œë¬¸ì)
  reason = reason.replace(/btl/gi, 'BTL');
  reason = reason.replace(/cap/gi, 'CAP');
  
  // ìƒìˆ˜ í‘œì¤€ ë§¤í•‘ (ë„ì–´ì“°ê¸° ë¬´ì‹œí•˜ê³  ë§¤ì¹­)
  const waterStandardMap = {
    '0.33L ì œí’ˆìƒì‚°': ['0.33lì œí’ˆìƒì‚°', '0.33Lì œí’ˆìƒì‚°', '0,33lì œí’ˆìƒì‚°', '0,33Lì œí’ˆìƒì‚°'],
    '0.33L BTLìƒì‚°': ['0.33lbtlìƒì‚°', '0.33LBTLìƒì‚°', '0.33lë³‘ìƒì‚°', '0,33lbtlìƒì‚°', '0,33LBTLìƒì‚°'],
    '0.33L btlcapìƒì‚°': ['0.33lbtlcapìƒì‚°', '0.33LBTLCAPìƒì‚°', '0,33lbtlcapìƒì‚°', '0,33LBTLCAPìƒì‚°'],
    '0.5L BTL/CAP ìƒì‚°': ['0.5lbtl/capìƒì‚°', '0.5LBTL/CAPìƒì‚°', '0.5lbtlcapìƒì‚°', '0,5lbtl/capìƒì‚°', '0,5LBTL/CAPìƒì‚°'],
    '0.5L BTL ìƒì‚°': ['0.5lbtlìƒì‚°', '0.5LBTLìƒì‚°', '0,5lbtlìƒì‚°', '0,5LBTLìƒì‚°'],
    '0.5L ì œí’ˆìƒì‚°': ['05lì œí’ˆìƒì‚°', '05Lì œí’ˆìƒì‚°', '0.5lì œí’ˆìƒì‚°', '0.5Lì œí’ˆìƒì‚°', '0,5lì œí’ˆìƒì‚°', '0,5Lì œí’ˆìƒì‚°'],
    '1.5L BTLìƒì‚°': ['1.5lbtlìƒì‚°', '1.5LBTLìƒì‚°', '1.5lë³‘ìƒì‚°', '1,5lbtlìƒì‚°', '1,5LBTLìƒì‚°'],
    '1.5L ì œí’ˆìƒì‚°': ['1.5lì œí’ˆìƒì‚°', '1.5Lì œí’ˆìƒì‚°', '1,5lì œí’ˆìƒì‚°', '1,5Lì œí’ˆìƒì‚°']
  };
  
  // í‘œì¤€í™” ì ìš©
  for (const [standard, variations] of Object.entries(waterStandardMap)) {
    // ë„ì–´ì“°ê¸° ì œê±°í•œ í‘œì¤€ê°’
    const noSpaceStandard = standard.replace(/\s+/g, '').toLowerCase();
    
    if (noSpaceReason.includes(noSpaceStandard) || 
        variations.some(v => noSpaceReason.includes(v.toLowerCase()))) {
      return standard;
    }
  }
  
  // ì¼ë°˜ì ì¸ íŒ¨í„´ ë§¤ì¹­ (ì»´ë§ˆ í¬í•¨)
  const patterns = [
    { pattern: /0[.,]33\s*[Ll]\s*ì œí’ˆ\s*ìƒì‚°/, standard: '0.33L ì œí’ˆìƒì‚°' },
    { pattern: /0[.,]33\s*[Ll]\s*BTL\s*ìƒì‚°/, standard: '0.33L BTLìƒì‚°' },
    { pattern: /0[.,]33\s*[Ll]\s*btlcap\s*ìƒì‚°/i, standard: '0.33L btlcapìƒì‚°' },
    { pattern: /0[.,]5\s*[Ll]\s*BTL[\/\s]*CAP\s*ìƒì‚°/i, standard: '0.5L BTL/CAP ìƒì‚°' },
    { pattern: /0[.,]5\s*[Ll]\s*BTL\s*ìƒì‚°/i, standard: '0.5L BTL ìƒì‚°' },
    { pattern: /05\s*[Ll]\s*ì œí’ˆ\s*ìƒì‚°/, standard: '0.5L ì œí’ˆìƒì‚°' },
    { pattern: /0[.,]5\s*[Ll]\s*ì œí’ˆ\s*ìƒì‚°/, standard: '0.5L ì œí’ˆìƒì‚°' },
    { pattern: /1[.,]5\s*[Ll]\s*BTL\s*ìƒì‚°/, standard: '1.5L BTLìƒì‚°' },
    { pattern: /1[.,]5\s*[Ll]\s*ì œí’ˆ\s*ìƒì‚°/, standard: '1.5L ì œí’ˆìƒì‚°' }
  ];
  
  for (const { pattern, standard } of patterns) {
    if (pattern.test(reason)) {
      return standard;
    }
  }
  
  return reason;
}

// 7. ì›ë³¸ ë°ì´í„° í…Œë‘ë¦¬ ì¶”ê°€
function addBorderToOriginalData(sheet) {
  const lastRow = getLastDataRow(sheet);
  const lastCol = 35; // AIì—´ê¹Œì§€
  
  // ì›ë³¸ ë°ì´í„° ë²”ìœ„ì—ë§Œ í…Œë‘ë¦¬ ì ìš©
  const dataRange = sheet.getRange(1, 1, lastRow, lastCol);
  dataRange.setBorder(true, true, true, true, true, true, "black", SpreadsheetApp.BorderStyle.SOLID);
  
  // í—¤ë”(1í–‰) ì„œì‹ ì ìš©
  const headerRange = sheet.getRange(1, 1, 1, lastCol);
  headerRange.setFontWeight("bold");
  headerRange.setBackground("#a4c2f4"); // í•˜ëŠ˜ìƒ‰ 2
}

// ë°ì´í„°ì˜ ë§ˆì§€ë§‰ í–‰ ì°¾ê¸° - ë” ì•ˆì „í•œ ë²„ì „
function getLastDataRow(sheet) {
  const sheetName = sheet.getName();
  const maxRows = sheet.getMaxRows();
  
  console.log(`${sheetName}: ë§ˆì§€ë§‰ ë°ì´í„° í–‰ ì°¾ê¸° ì‹œì‘`);
  console.log(`${sheetName}: ì‹œíŠ¸ ìµœëŒ€ í–‰: ${maxRows}`);
  
  // getLastRow() ë¨¼ì € ì‹œë„
  try {
    const lastRow = sheet.getLastRow();
    console.log(`${sheetName}: getLastRow() ê²°ê³¼: ${lastRow}`);
    
    // lastRowê°€ 0ì´ë©´ ë¹ˆ ì‹œíŠ¸
    if (lastRow === 0) {
      console.log(`${sheetName}: ë¹ˆ ì‹œíŠ¸`);
      return 0;
    }
    
    // lastRow ì´í›„ ëª‡ í–‰ì„ ì¶”ê°€ë¡œ í™•ì¸
    let actualLastRow = lastRow;
    const checkRows = Math.min(10, maxRows - lastRow);
    
    for (let i = 1; i <= checkRows; i++) {
      const row = lastRow + i;
      if (row > maxRows) break;
      
      try {
        // í•œ ë²ˆì— ì ì€ ì—´ë§Œ í™•ì¸
        const rowData = sheet.getRange(row, 1, 1, Math.min(10, sheet.getLastColumn())).getValues()[0];
        const hasData = rowData.some(cell => cell !== "" && cell !== null);
        
        if (hasData) {
          actualLastRow = row;
          console.log(`${sheetName}: ì¶”ê°€ ë°ì´í„° ë°œê²¬ - í–‰ ${row}`);
        }
      } catch (e) {
        console.log(`${sheetName}: í–‰ ${row} í™•ì¸ ì¤‘ ì˜¤ë¥˜ (ë¬´ì‹œ)`);
        break;
      }
    }
    
    console.log(`${sheetName}: ìµœì¢… ë§ˆì§€ë§‰ ë°ì´í„° í–‰: ${actualLastRow}`);
    return actualLastRow;
    
  } catch (error) {
    console.error(`${sheetName}: getLastRow() ì‹¤íŒ¨, ëŒ€ì²´ ë°©ë²• ì‚¬ìš©`);
    console.error(error.toString());
    
    // ëŒ€ì²´ ë°©ë²•: ë’¤ì—ì„œë¶€í„° í™•ì¸
    for (let row = maxRows; row >= 1; row--) {
      try {
        // Aì—´ë§Œ í™•ì¸í•˜ì—¬ ì„±ëŠ¥ í–¥ìƒ
        const cellValue = sheet.getRange(row, 1).getValue();
        if (cellValue !== "" && cellValue !== null) {
          console.log(`${sheetName}: ëŒ€ì²´ ë°©ë²•ìœ¼ë¡œ ì°¾ì€ ë§ˆì§€ë§‰ í–‰: ${row}`);
          return row;
        }
      } catch (e) {
        // ê³„ì† ì§„í–‰
      }
    }
    
    console.log(`${sheetName}: ë°ì´í„° ì—†ìŒ`);
    return 0;
  }
}

// 8. ì‚¬ìœ ë³„ ì‹œê°„ ë¶„ë°° ë° ì§‘ê³„
function distributeAndSummarize(sheet) {
  const sheetName = sheet.getName();
  const lastRow = getLastDataRow(sheet);
  const dailyData = [];
  const reasonSummary = {};
  
  console.log(`${sheetName}: ì‚¬ìœ ë³„ ì§‘ê³„ ì‹œì‘ - ë°ì´í„° í–‰: 2 ~ ${lastRow}`);
  
  let processedRows = 0;
  let skippedRows = 0;
  
  for (let row = 2; row <= lastRow; row++) {
    try {
      const date = sheet.getRange(row, 9).getValue(); // Iì—´ (ì‹ ì²­ ê·¼ë¬´ì¼)
      const totalMinutes = sheet.getRange(row, 21).getValue(); // Uì—´ (ê²°ê³¼ì‹œê°„)
      
      console.log(`${sheetName}: í–‰ ${row} - ë‚ ì§œ: ${date}, ì‹œê°„: ${totalMinutes}`);
      
      if (date && totalMinutes) {
        // AF, AG, AH ì—´ì—ì„œ ì‚¬ìœ  ìˆ˜ì§‘
        const reasons = [];
        for (let col = 32; col <= 34; col++) { // AF=32, AG=33, AH=34
          const reason = sheet.getRange(row, col).getValue();
          if (reason) {
            reasons.push(reason);
            console.log(`${sheetName}: í–‰ ${row} - ì‚¬ìœ  ${col-31}: "${reason}"`);
          }
        }
        
        if (reasons.length > 0) {
          const minutesPerReason = totalMinutes / reasons.length;
          console.log(`${sheetName}: í–‰ ${row} - ì‚¬ìœ ë‹¹ ì‹œê°„: ${minutesPerReason}ë¶„`);
          
          // ì¼ë³„ ë°ì´í„° ì €ì¥
          const dayData = {
            date: formatDate(date),
            reasons: reasons,
            minutes: reasons.map(() => minutesPerReason)
          };
          dailyData.push(dayData);
          
          // ì‚¬ìœ ë³„ ì§‘ê³„
          reasons.forEach(reason => {
            if (!reasonSummary[reason]) {
              reasonSummary[reason] = {count: 0, minutes: 0};
            }
            reasonSummary[reason].count += 1;
            reasonSummary[reason].minutes += minutesPerReason;
          });
          
          processedRows++;
        } else {
          console.warn(`${sheetName}: í–‰ ${row} - ì‚¬ìœ ê°€ ì—†ìŒ`);
          skippedRows++;
        }
      } else {
        if (!date) console.log(`${sheetName}: í–‰ ${row} - ë‚ ì§œ ì—†ìŒ`);
        if (!totalMinutes) console.log(`${sheetName}: í–‰ ${row} - ì‹œê°„ ì—†ìŒ`);
        skippedRows++;
      }
    } catch (error) {
      console.error(`${sheetName}: í–‰ ${row} ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ${error.toString()}`);
      skippedRows++;
    }
  }
  
  console.log(`${sheetName}: ì§‘ê³„ ì™„ë£Œ - ì²˜ë¦¬: ${processedRows}í–‰, ê±´ë„ˆëœ€: ${skippedRows}í–‰`);
  console.log(`${sheetName}: ì‚¬ìœ ë³„ ìš”ì•½:`, JSON.stringify(reasonSummary, null, 2));
  
  // ì¤‘ê°„ ì •ë¦¬í‘œ ìƒì„±
  try {
    createIntermediateTables(sheet, dailyData, reasonSummary);
  } catch (error) {
    console.error(`${sheetName}: ì¤‘ê°„ ì •ë¦¬í‘œ ìƒì„± ì¤‘ ì˜¤ë¥˜: ${error.toString()}`);
  }
  
  return reasonSummary;
}

// ë‚ ì§œ í¬ë§· í•¨ìˆ˜
function formatDate(date) {
  if (date instanceof Date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }
  return date.toString();
}

// ì¤‘ê°„ ì •ë¦¬í‘œ ìƒì„±
function createIntermediateTables(sheet, dailyData, reasonSummary) {
  const startRow = sheet.getLastRow() + 3;
  
  // ìŠ¤íƒ€ì¼ ì„¤ì •
  const headerColor = "#a4c2f4"; // í•˜ëŠ˜ìƒ‰ 2
  const fontFamily = "Malgun Gothic"; // ë§‘ì€ ê³ ë”•
  
  // ì¼ë³„ ì‚¬ìœ  ë¶„ì„ í‘œ
  createDailyReasonTable(sheet, startRow, dailyData, headerColor, fontFamily);
  
  // ì‹œê°„ ë¶„ë°° í‘œ
  const timeTableStartRow = startRow + dailyData.length + 5;
  createTimeDistributionTable(sheet, timeTableStartRow, dailyData, headerColor, fontFamily);
  
  // ì‚¬ìœ ë³„ ì§‘ê³„í‘œ
  const summaryStartRow = timeTableStartRow + dailyData.length + 5;
  createReasonSummaryTable(sheet, summaryStartRow, reasonSummary, headerColor, fontFamily);
}

// ì¼ë³„ ì‚¬ìœ  ë¶„ì„ í‘œ ìƒì„±
function createDailyReasonTable(sheet, startRow, dailyData, headerColor, fontFamily) {
  // ì œëª©
  sheet.getRange(startRow, 1).setValue("ì¼ë³„ ì‚¬ìœ  ë¶„ì„")
    .setFontWeight("bold")
    .setFontFamily(fontFamily)
    .setFontSize(13);
  
  // í—¤ë”
  const headerRange = sheet.getRange(startRow + 1, 1, 1, 4);
  headerRange.setValues([["ê·¼ë¬´ì¼", "ì‹ ì²­ì‚¬ìœ 1", "ì‹ ì²­ì‚¬ìœ 2", "ì‹ ì²­ì‚¬ìœ 3"]])
    .setBackground(headerColor)
    .setFontWeight("bold")
    .setFontFamily(fontFamily)
    .setFontSize(11)
    .setHorizontalAlignment("center");
  
  // ë°ì´í„°
  let currentRow = startRow + 2;
  dailyData.forEach(day => {
    sheet.getRange(currentRow, 1).setValue(day.date);
    day.reasons.forEach((reason, idx) => {
      if (idx < 3) {
        sheet.getRange(currentRow, idx + 2).setValue(reason);
      }
    });
    currentRow++;
  });
  
  // ìŠ¤íƒ€ì¼ ì ìš©
  const dataRange = sheet.getRange(startRow + 2, 1, dailyData.length, 4);
  dataRange.setFontFamily(fontFamily)
    .setFontSize(11)
    .setHorizontalAlignment("center");
  
  // í…Œë‘ë¦¬
  const tableRange = sheet.getRange(startRow + 1, 1, dailyData.length + 1, 4);
  tableRange.setBorder(true, true, true, true, true, true, "black", SpreadsheetApp.BorderStyle.SOLID);
  
  // í–‰ ë†’ì´
  for (let i = startRow + 1; i <= startRow + dailyData.length + 1; i++) {
    sheet.setRowHeight(i, 32);
  }
  
  // ì—´ ë„ˆë¹„ ê³ ì • ì„¤ì •
  sheet.setColumnWidth(1, 140); // Aì—´
  sheet.setColumnWidth(2, 160); // Bì—´
  sheet.setColumnWidth(3, 160); // Cì—´
  sheet.setColumnWidth(4, 160); // Dì—´
}

// ì‹œê°„ ë¶„ë°° í‘œ ìƒì„±
function createTimeDistributionTable(sheet, startRow, dailyData, headerColor, fontFamily) {
  // ì œëª©
  sheet.getRange(startRow, 1).setValue("ì¼ë³„ ì‹œê°„ ë¶„ë°°")
    .setFontWeight("bold")
    .setFontFamily(fontFamily)
    .setFontSize(13);
  
  // í—¤ë”
  const headerRange = sheet.getRange(startRow + 1, 1, 1, 4);
  headerRange.setValues([["ê·¼ë¬´ì¼", "ì‹ ì²­ì‚¬ìœ 1 ì‹œê°„", "ì‹ ì²­ì‚¬ìœ 2 ì‹œê°„", "ì‹ ì²­ì‚¬ìœ 3 ì‹œê°„"]])
    .setBackground(headerColor)
    .setFontWeight("bold")
    .setFontFamily(fontFamily)
    .setFontSize(11)
    .setHorizontalAlignment("center");
  
  // ë°ì´í„°
  let currentRow = startRow + 2;
  let totalMinutes = [0, 0, 0];
  
  dailyData.forEach(day => {
    sheet.getRange(currentRow, 1).setValue(day.date);
    day.minutes.forEach((minutes, idx) => {
      if (idx < 3) {
        sheet.getRange(currentRow, idx + 2).setValue(minutes);
        totalMinutes[idx] += minutes;
      }
    });
    currentRow++;
  });
  
  // í•©ê³„ í–‰
  sheet.getRange(currentRow, 1).setValue("í•©ê³„")
    .setFontWeight("bold")
    .setFontFamily(fontFamily)
    .setFontSize(11)
    .setHorizontalAlignment("center");
  
  for (let i = 0; i < 3; i++) {
    sheet.getRange(currentRow, i + 2).setValue(totalMinutes[i])
      .setFontWeight("bold")
      .setFontSize(11);
  }
  
  // ìŠ¤íƒ€ì¼ ì ìš©
  const dataRange = sheet.getRange(startRow + 2, 1, dailyData.length + 1, 4);
  dataRange.setFontFamily(fontFamily)
    .setFontSize(11);
  
  // ë‚ ì§œëŠ” ê°€ìš´ë° ì •ë ¬
  sheet.getRange(startRow + 2, 1, dailyData.length + 1, 1).setHorizontalAlignment("center");
  
  // ìˆ«ìëŠ” ì˜¤ë¥¸ìª½ ì •ë ¬
  sheet.getRange(startRow + 2, 2, dailyData.length + 1, 3).setHorizontalAlignment("right");
  
  // í…Œë‘ë¦¬
  const tableRange = sheet.getRange(startRow + 1, 1, dailyData.length + 2, 4);
  tableRange.setBorder(true, true, true, true, true, true, "black", SpreadsheetApp.BorderStyle.SOLID);
  
  // í–‰ ë†’ì´
  for (let i = startRow + 1; i <= startRow + dailyData.length + 2; i++) {
    sheet.setRowHeight(i, 32);
  }
  
  // ì—´ ë„ˆë¹„ ê³ ì • ì„¤ì •
  sheet.setColumnWidth(1, 140); // Aì—´
  sheet.setColumnWidth(2, 160); // Bì—´
  sheet.setColumnWidth(3, 160); // Cì—´
  sheet.setColumnWidth(4, 160); // Dì—´
}

// ì‚¬ìœ ë³„ ì§‘ê³„í‘œ ìƒì„±
function createReasonSummaryTable(sheet, startRow, reasonSummary, headerColor, fontFamily) {
  const month = sheet.getName().match(/(\d+)ë…„\s*(\d+)ì›”/);
  const monthLabel = month ? `${month[2]}ì›” ì‚¬ìœ ` : "ì‚¬ìœ ";
  
  // ì œëª©
  sheet.getRange(startRow, 1).setValue("ì‚¬ìœ ë³„ ì§‘ê³„")
    .setFontWeight("bold")
    .setFontFamily(fontFamily)
    .setFontSize(13);
  
  // í—¤ë”
  const headerRange = sheet.getRange(startRow + 1, 1, 1, 3);
  headerRange.setValues([[monthLabel, "íšŸìˆ˜", "ê²°ê³¼ì‹œê°„"]])
    .setBackground(headerColor)
    .setFontWeight("bold")
    .setFontFamily(fontFamily)
    .setFontSize(11)
    .setHorizontalAlignment("center");
  
  // ë°ì´í„°
  let currentRow = startRow + 2;
  let totalCount = 0;
  let totalMinutes = 0;
  
  for (const [reason, data] of Object.entries(reasonSummary)) {
    sheet.getRange(currentRow, 1).setValue(reason)
      .setFontSize(11);
    sheet.getRange(currentRow, 2).setValue(data.count)
      .setFontSize(11);
    sheet.getRange(currentRow, 3).setValue(data.minutes)
      .setFontSize(11);
    totalCount += data.count;
    totalMinutes += data.minutes;
    currentRow++;
  }
  
  // í•©ê³„ í–‰
  sheet.getRange(currentRow, 1).setValue("í•©ê³„")
    .setFontWeight("bold")
    .setFontFamily(fontFamily)
    .setFontSize(11)
    .setHorizontalAlignment("center");
  sheet.getRange(currentRow, 2).setValue(totalCount)
    .setFontWeight("bold")
    .setFontSize(11);
  sheet.getRange(currentRow, 3).setValue(totalMinutes)
    .setFontWeight("bold")
    .setFontSize(11);
  
  // ìŠ¤íƒ€ì¼ ì ìš©
  const dataRange = sheet.getRange(startRow + 2, 1, Object.keys(reasonSummary).length + 1, 3);
  dataRange.setFontFamily(fontFamily);
  
  // ì‚¬ìœ ëŠ” ê°€ìš´ë° ì •ë ¬
  sheet.getRange(startRow + 2, 1, Object.keys(reasonSummary).length + 1, 1).setHorizontalAlignment("center");
  
  // ìˆ«ìëŠ” ì˜¤ë¥¸ìª½ ì •ë ¬
  sheet.getRange(startRow + 2, 2, Object.keys(reasonSummary).length + 1, 2).setHorizontalAlignment("right");
  
  // í…Œë‘ë¦¬
  const tableRange = sheet.getRange(startRow + 1, 1, Object.keys(reasonSummary).length + 2, 3);
  tableRange.setBorder(true, true, true, true, true, true, "black", SpreadsheetApp.BorderStyle.SOLID);
  
  // í–‰ ë†’ì´
  for (let i = startRow + 1; i <= startRow + Object.keys(reasonSummary).length + 2; i++) {
    sheet.setRowHeight(i, 32);
  }
  
  // ì—´ ë„ˆë¹„ ê³ ì • ì„¤ì •
  sheet.setColumnWidth(1, 140); // Aì—´
  sheet.setColumnWidth(2, 160); // Bì—´
  sheet.setColumnWidth(3, 160); // Cì—´
}

// ë¹„êµ ë¦¬í¬íŠ¸ ìƒì„± - ë™ì ìœ¼ë¡œ ë…„ì›” ì°¾ê¸°
function createComparisonReport(processedData) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // ì²˜ë¦¬ëœ ì‹œíŠ¸ ì •ë³´ ë¶„ì„
  const sheetInfos = [];
  Object.keys(processedData).forEach(sheetName => {
    const match = sheetName.match(/^(\d{4})ë…„\s*(\d+)ì›”\s*\((ì¶•ì‚°|ìƒìˆ˜)\)$/);
    if (match) {
      sheetInfos.push({
        name: sheetName,
        year: parseInt(match[1]),
        month: parseInt(match[2]),
        type: match[3],
        data: processedData[sheetName]
      });
    }
  });
  
  // íƒ€ì…ë³„ë¡œ ë¶„ë¦¬
  const livestockSheets = sheetInfos.filter(s => s.type === 'ì¶•ì‚°');
  const waterSheets = sheetInfos.filter(s => s.type === 'ìƒìˆ˜');
  
  // ì¶•ì‚° ë¦¬í¬íŠ¸ ìƒì„±
  if (livestockSheets.length >= 2) {
    createTypeSpecificReport(ss, livestockSheets, 'ì¶•ì‚°');
  }
  
  // ìƒìˆ˜ ë¦¬í¬íŠ¸ ìƒì„±
  if (waterSheets.length >= 2) {
    createTypeSpecificReport(ss, waterSheets, 'ìƒìˆ˜');
  }
}

// íƒ€ì…ë³„ ë¦¬í¬íŠ¸ ìƒì„±
function createTypeSpecificReport(ss, sheets, type) {
  // ë‚ ì§œìˆœ ì •ë ¬ (ìµœì‹ ìˆœ)
  sheets.sort((a, b) => {
    if (a.year !== b.year) return b.year - a.year;
    return b.month - a.month;
  });
  
  const reportSheetName = `${type} ì›”ë§ ë§ˆê° ë¦¬í¬íŠ¸`;
  let reportSheet = ss.getSheetByName(reportSheetName);
  
  if (!reportSheet) {
    reportSheet = ss.insertSheet(reportSheetName);
  } else {
    reportSheet.clear();
  }
  
  // ìŠ¤íƒ€ì¼ ì„¤ì •
  const headerColor = "#a4c2f4"; // í•˜ëŠ˜ìƒ‰ 2
  const fontFamily = "Malgun Gothic"; // ë§‘ì€ ê³ ë”•
  
  // í˜„ì¬, ì „ì›”, ì‘ë…„ ì‹œíŠ¸ ì°¾ê¸°
  const current = sheets[0];
  const prevMonth = sheets.find(s => 
    (s.year === current.year && s.month === current.month - 1) ||
    (s.year === current.year - 1 && current.month === 1 && s.month === 12)
  );
  const prevYear = sheets.find(s => s.year === current.year - 1 && s.month === current.month);
  
  // ëª¨ë“  ì‚¬ìœ  ëª©ë¡ ìƒì„±
  const allReasons = new Set();
  sheets.forEach(sheet => {
    if (sheet.data) {
      Object.keys(sheet.data).forEach(reason => allReasons.add(reason));
    }
  });
  
  let row = 1;
  
  // 1. ê¸ˆì›” vs ì „ì›” ë¹„êµí‘œ
  if (current && prevMonth) {
    row = createComparisonTable(reportSheet, row, 
      `ê¸ˆì›”, ì „ì›” ì‚¬ìœ  íšŸìˆ˜ ë° ê·¼ë¬´ì‹œê°„`,
      ["ì‚¬ìœ ", `${current.year}ë…„ ${current.month}ì›”`, `${prevMonth.year}ë…„ ${prevMonth.month}ì›”`], 
      allReasons, current.data, prevMonth.data, 
      headerColor, fontFamily, false);
    row += 3;
  }
  
  // 2. ê¸ˆì›” vs ì „ë…„ ë™ì›” ë¹„êµí‘œ
  if (current && prevYear) {
    row = createComparisonTable(reportSheet, row, 
      `ê¸ˆì›”, ì „ë…„ ë™ì›” ì‚¬ìœ  íšŸìˆ˜ ë° ê·¼ë¬´ì‹œê°„`,
      ["ì‚¬ìœ ", `${current.year}ë…„ ${current.month}ì›”`, `${prevYear.year}ë…„ ${prevYear.month}ì›”`], 
      allReasons, current.data, prevYear.data,
      headerColor, fontFamily, false);
    row += 3;
  }
  
  // 3. ì „ì›” ëŒ€ë¹„ ì¦ê°í‘œ
  if (current && prevMonth) {
    row = createDifferenceTable(reportSheet, row, "ì „ì›”ëŒ€ë¹„ ì¦ê°íšŸìˆ˜ ë° ì‹œê°„",
      allReasons, current.data, prevMonth.data, headerColor, fontFamily);
    row += 3;
  }
  
  // 4. ì „ë…„ ë™ì›” ëŒ€ë¹„ ì¦ê°í‘œ
  if (current && prevYear) {
    row = createDifferenceTable(reportSheet, row, "ì „ë…„ ë™ì›”ëŒ€ë¹„ ì¦ê°íšŸìˆ˜ ë° ì‹œê°„",
      allReasons, current.data, prevYear.data, headerColor, fontFamily);
  }
}

// ë¹„êµí‘œ ìƒì„± í•¨ìˆ˜
function createComparisonTable(sheet, startRow, title, headers, reasons, data1, data2, 
  headerColor, fontFamily, isDifference) {
  
  // ì œëª©
  sheet.getRange(startRow, 1).setValue(title)
    .setFontWeight("bold")
    .setFontFamily(fontFamily)
    .setFontSize(13);
  
  startRow += 2;
  
  // í—¤ë”
  const headerRange = sheet.getRange(startRow, 1, 1, 3);
  headerRange.setValues([headers])
    .setBackground(headerColor)
    .setFontWeight("bold")
    .setFontFamily(fontFamily)
    .setFontSize(11)
    .setHorizontalAlignment("center");
  
  // ë°ì´í„°
  let currentRow = startRow + 1;
  reasons.forEach(reason => {
    sheet.getRange(currentRow, 1).setValue(reason)
      .setFontSize(11);
    
    if (!isDifference) {
      sheet.getRange(currentRow, 2).setValue(
        data1[reason] ? `${data1[reason].count}íšŒ / ${data1[reason].minutes}ë¶„` : "0íšŒ / 0ë¶„"
      ).setFontSize(11);
      sheet.getRange(currentRow, 3).setValue(
        data2[reason] ? `${data2[reason].count}íšŒ / ${data2[reason].minutes}ë¶„` : "0íšŒ / 0ë¶„"
      ).setFontSize(11);
    }
    currentRow++;
  });
  
  // ìŠ¤íƒ€ì¼ ì ìš©
  const dataRange = sheet.getRange(startRow + 1, 1, reasons.size, 3);
  dataRange.setFontFamily(fontFamily)
    .setHorizontalAlignment("center");
  
  // í…Œë‘ë¦¬
  const tableRange = sheet.getRange(startRow, 1, reasons.size + 1, 3);
  tableRange.setBorder(true, true, true, true, true, true, "black", SpreadsheetApp.BorderStyle.SOLID);
  
  // í–‰ ë†’ì´
  for (let i = startRow; i <= startRow + reasons.size; i++) {
    sheet.setRowHeight(i, 32);
  }
  
  // ì—´ ë„ˆë¹„ ê³ ì • ì„¤ì •
  sheet.setColumnWidth(1, 140); // Aì—´
  sheet.setColumnWidth(2, 160); // Bì—´
  sheet.setColumnWidth(3, 160); // Cì—´
  
  return currentRow;
}

// ì¦ê°í‘œ ìƒì„± í•¨ìˆ˜
function createDifferenceTable(sheet, startRow, title, reasons, current, comparison, 
  headerColor, fontFamily) {
  
  // ì œëª©
  sheet.getRange(startRow, 1).setValue(title)
    .setFontWeight("bold")
    .setFontFamily(fontFamily)
    .setFontSize(13);
  
  startRow += 2;
  
  // í—¤ë”
  const headerRange = sheet.getRange(startRow, 1, 1, 3);
  headerRange.setValues([["ì‚¬ìœ ", "íšŸìˆ˜ ì¦ê°", "ì‹œê°„ ì¦ê°"]])
    .setBackground(headerColor)
    .setFontWeight("bold")
    .setFontFamily(fontFamily)
    .setFontSize(11)
    .setHorizontalAlignment("center");
  
  // ë°ì´í„°
  let currentRow = startRow + 1;
  let totalCountDiff = 0;
  let totalMinutesDiff = 0;
  
  reasons.forEach(reason => {
    const currentData = current[reason] || {count: 0, minutes: 0};
    const compData = comparison[reason] || {count: 0, minutes: 0};
    const countDiff = currentData.count - compData.count;
    const minutesDiff = currentData.minutes - compData.minutes;
    
    sheet.getRange(currentRow, 1).setValue(reason)
      .setFontSize(11);
    sheet.getRange(currentRow, 2).setValue(countDiff)
      .setFontSize(11);
    sheet.getRange(currentRow, 3).setValue(minutesDiff)
      .setFontSize(11);
    
    totalCountDiff += countDiff;
    totalMinutesDiff += minutesDiff;
    currentRow++;
  });
  
  // í•©ê³„ í–‰
  sheet.getRange(currentRow, 1).setValue("í•©ê³„")
    .setFontWeight("bold")
    .setFontFamily(fontFamily)
    .setFontSize(11)
    .setHorizontalAlignment("center");
  sheet.getRange(currentRow, 2).setValue(totalCountDiff)
    .setFontWeight("bold")
    .setFontSize(11);
  sheet.getRange(currentRow, 3).setValue(totalMinutesDiff)
    .setFontWeight("bold")
    .setFontSize(11);
  
  // ìŠ¤íƒ€ì¼ ì ìš©
  const dataRange = sheet.getRange(startRow + 1, 1, reasons.size + 1, 3);
  dataRange.setFontFamily(fontFamily);
  
  // ì‚¬ìœ ëŠ” ê°€ìš´ë° ì •ë ¬
  sheet.getRange(startRow + 1, 1, reasons.size + 1, 1).setHorizontalAlignment("center");
  
  // ìˆ«ìëŠ” ì˜¤ë¥¸ìª½ ì •ë ¬
  sheet.getRange(startRow + 1, 2, reasons.size + 1, 2).setHorizontalAlignment("right");
  
  // í…Œë‘ë¦¬
  const tableRange = sheet.getRange(startRow, 1, reasons.size + 2, 3);
  tableRange.setBorder(true, true, true, true, true, true, "black", SpreadsheetApp.BorderStyle.SOLID);
  
  // í–‰ ë†’ì´
  for (let i = startRow; i <= startRow + reasons.size + 1; i++) {
    sheet.setRowHeight(i, 32);
  }
  
  // ì—´ ë„ˆë¹„ ê³ ì • ì„¤ì •
  sheet.setColumnWidth(1, 140); // Aì—´
  sheet.setColumnWidth(2, 160); // Bì—´
  sheet.setColumnWidth(3, 160); // Cì—´
  
  return currentRow;
}

// ì›ë³¸ ë°ì´í„° ì •ë¦¬ í•¨ìˆ˜
function cleanupOriginalData(sheet) {
  // ì›ë³¸ ë°ì´í„°ì˜ ë§ˆì§€ë§‰ í–‰ ì°¾ê¸°
  const lastDataRow = getLastDataRow(sheet);
  
  // ë’¤ì—ì„œë¶€í„° ì—´ ì‚­ì œ (ì¸ë±ìŠ¤ ë³€ê²½ ë°©ì§€)
  try {
    // 1. X:AD ì—´ ì‚­ì œ (X=24, AD=30, ì´ 7ê°œ ì—´)
    for (let col = 30; col >= 24; col--) {
      sheet.getRange(1, col, lastDataRow, 1).deleteCells(SpreadsheetApp.Dimension.COLUMNS);
    }
    
    // 2. O:P ì—´ ì‚­ì œ (O=15, P=16, ì´ 2ê°œ ì—´)
    for (let col = 16; col >= 15; col--) {
      sheet.getRange(1, col, lastDataRow, 1).deleteCells(SpreadsheetApp.Dimension.COLUMNS);
    }
    
    // 3. Jì—´ ì‚­ì œ (J=10)
    sheet.getRange(1, 10, lastDataRow, 1).deleteCells(SpreadsheetApp.Dimension.COLUMNS);
    
    // 4. Dì—´ (ë°˜ë ¤ì—¬ë¶€) ì‚­ì œ
    sheet.getRange(1, 4, lastDataRow, 1).deleteCells(SpreadsheetApp.Dimension.COLUMNS);
    
  } catch (e) {
    console.log("ì—´ ì‚­ì œ ì˜¤ë¥˜: " + e.toString());
  }
  
  // ì‚­ì œ í›„ ìƒˆë¡œìš´ ì—´ ê°œìˆ˜ ê³„ì‚°
  const newLastCol = 24;
  
  // ì›ë³¸ ë°ì´í„° ë²”ìœ„ì— í…Œë‘ë¦¬ ì ìš©
  const dataRange = sheet.getRange(1, 1, lastDataRow, newLastCol);
  dataRange.setBorder(true, true, true, true, true, true, "black", SpreadsheetApp.BorderStyle.SOLID);
  
  // í—¤ë” ì„œì‹ ì ìš©
  const headerRange = sheet.getRange(1, 1, 1, newLastCol);
  headerRange.setFontWeight("bold");
  headerRange.setBackground("#a4c2f4"); // í•˜ëŠ˜ìƒ‰ 2
  headerRange.setHorizontalAlignment("center");
  
  // ë³€ê²½ì‚¬í•­ ê°•ì œ ì ìš©
  SpreadsheetApp.flush();
}

// ========== ì´ ì •ë¦¬ í‘œ ê´€ë ¨ í•¨ìˆ˜ (ìˆ˜ì •ë³¸) ==========

// ê°œì„ ëœ ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateSummaryTable(processedData) {
  console.log('\n' + '='.repeat(60));
  console.log('ğŸ“Š ===== ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸ ì‹œì‘ =====');
  console.log('='.repeat(60));
  
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let summarySheet = ss.getSheetByName('ì´ ì •ë¦¬ í‘œ');
  
  if (!summarySheet) {
    console.log('âŒ ì´ ì •ë¦¬ í‘œ ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
    SpreadsheetApp.getUi().alert('ì´ ì •ë¦¬ í‘œ ì‹œíŠ¸ë¥¼ ë¨¼ì € ë§Œë“¤ì–´ì£¼ì„¸ìš”.');
    return;
  }
  
  console.log('âœ… ì´ ì •ë¦¬ í‘œ ì‹œíŠ¸ ë°œê²¬');
  
  // 3í–‰ì˜ í—¤ë” ì½ê¸° (B3:D3)
  const headers = summarySheet.getRange(3, 2, 1, 3).getValues()[0];
  console.log('\nğŸ“‹ ì´ ì •ë¦¬ í‘œ í—¤ë” í™•ì¸:');
  console.log(`  B3: "${headers[0]}"`);
  console.log(`  C3: "${headers[1]}"`);
  console.log(`  D3: "${headers[2]}"`);
  
  // í—¤ë”ì—ì„œ ì›” ì •ë³´ íŒŒì‹±
  const headerInfo = parseHeadersImproved(headers);
  console.log('\nğŸ“… íŒŒì‹±ëœ í—¤ë” ì •ë³´:');
  headerInfo.forEach((info, index) => {
    const col = String.fromCharCode(66 + index); // B, C, D
    if (info) {
      console.log(`  ${col}ì—´: ${info.year}ë…„ ${info.month}ì›”`);
    } else {
      console.log(`  ${col}ì—´: íŒŒì‹± ì‹¤íŒ¨`);
    }
  });
  
  // ì²˜ë¦¬ëœ ë°ì´í„°ì—ì„œ ì‹¤ì œ ì‹œíŠ¸ ì •ë³´ ìˆ˜ì§‘
  const sheetDataMap = collectSheetDataImproved(processedData);
  console.log('\nğŸ“Š ìˆ˜ì§‘ëœ ì‹œíŠ¸ ë°ì´í„°:');
  Object.keys(sheetDataMap).forEach(key => {
    const data = sheetDataMap[key];
    if (data) {
      console.log(`  ${key}: ${data.totalMinutes}ë¶„ = ${data.totalHours}ì‹œê°„`);
    } else {
      console.log(`  ${key}: ë°ì´í„° ì—†ìŒ`);
    }
  });
  
  // B4:D5 ì˜ì—­ ì—…ë°ì´íŠ¸
  console.log('\nğŸ”„ ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹œì‘...');
  updateSummaryDataImproved(summarySheet, headerInfo, sheetDataMap);
  
  console.log('\n' + '='.repeat(60));
  console.log('âœ… ===== ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸ ì™„ë£Œ =====');
  console.log('='.repeat(60));
}

// ê°œì„ ëœ ì‹œíŠ¸ ë°ì´í„° ìˆ˜ì§‘ í•¨ìˆ˜
function collectSheetDataImproved(processedData) {
  const sheetDataMap = {};
  
  console.log('\nğŸ“ˆ ì‹œíŠ¸ë³„ ë°ì´í„° ìˆ˜ì§‘ ì¤‘...');
  
  Object.keys(processedData).forEach(sheetName => {
    console.log(`\n  ì‹œíŠ¸: ${sheetName}`);
    
    const match = sheetName.match(/^(\d{4})ë…„\s*(\d+)ì›”\s*\((ì¶•ì‚°|ìƒìˆ˜)\)$/);
    if (match) {
      const year = parseInt(match[1]);
      const month = parseInt(match[2]);
      const type = match[3];
      
      // processedDataì—ì„œ í•©ê³„ ê³„ì‚°
      const totalMinutes = calculateTotalMinutes(processedData[sheetName]);
      const totalHours = Math.round(totalMinutes / 60); // ì •ìˆ˜ë¡œ ë°˜ì˜¬ë¦¼
      
      const key = `${year}-${month}-${type}`;
      sheetDataMap[key] = {
        sheetName: sheetName,
        year: year,
        month: month,
        type: type,
        totalMinutes: totalMinutes,
        totalHours: totalHours
      };
      
      console.log(`    â†’ í‚¤: ${key}`);
      console.log(`    â†’ ì´ ì‹œê°„: ${totalMinutes}ë¶„ = ${totalHours}ì‹œê°„`);
    } else {
      console.log(`    â†’ ì‹œíŠ¸ëª… í˜•ì‹ì´ ë§ì§€ ì•ŠìŒ`);
    }
  });
  
  return sheetDataMap;
}

// processedDataì—ì„œ ì´ ì‹œê°„ ê³„ì‚°
function calculateTotalMinutes(data) {
  let total = 0;
  if (data && typeof data === 'object') {
    Object.values(data).forEach(item => {
      if (item && item.minutes) {
        total += item.minutes;
      }
    });
  }
  return total;
}

// ì´ ì •ë¦¬ í‘œ ë°ì´í„° ì—…ë°ì´íŠ¸
function updateSummaryData(sheet, headerInfo, sheetDataMap) {
  console.log('\nğŸ“ ì…€ ì—…ë°ì´íŠ¸ ì¤‘...');
  
  // B4:D5 ì´ˆê¸°í™”
  sheet.getRange('B4:D5').clearContent();
  console.log('  B4:D5 ì˜ì—­ ì´ˆê¸°í™” ì™„ë£Œ');
  
  // ê° ì—´ë³„ë¡œ ì²˜ë¦¬
  headerInfo.forEach((header, colIndex) => {
    if (!header) {
      console.log(`\n  ${String.fromCharCode(66 + colIndex)}ì—´: í—¤ë” ì •ë³´ ì—†ìŒ - ê±´ë„ˆëœ€`);
      return;
    }
    
    const col = colIndex + 2; // B=2, C=3, D=4
    const colLetter = String.fromCharCode(66 + colIndex);
    
    console.log(`\n  ${colLetter}ì—´ ì²˜ë¦¬ (${header.year}ë…„ ${header.month}ì›”):`);
    
    // ì¶•ì‚° ë°ì´í„° (4í–‰)
    const livestockKey = `${header.year}-${header.month}-ì¶•ì‚°`;
    if (sheetDataMap[livestockKey]) {
      const value = sheetDataMap[livestockKey].totalHours;
      sheet.getRange(4, col).setValue(value);
      console.log(`    ${colLetter}4 (ì¶•ì‚°): ${value}ì‹œê°„ ì…ë ¥ ì™„ë£Œ`);
    } else {
      console.log(`    ${colLetter}4 (ì¶•ì‚°): ë°ì´í„° ì—†ìŒ`);
    }
    
    // ìƒìˆ˜ ë°ì´í„° (5í–‰)
    const waterKey = `${header.year}-${header.month}-ìƒìˆ˜`;
    if (sheetDataMap[waterKey]) {
      const value = sheetDataMap[waterKey].totalHours;
      sheet.getRange(5, col).setValue(value);
      console.log(`    ${colLetter}5 (ìƒìˆ˜): ${value}ì‹œê°„ ì…ë ¥ ì™„ë£Œ`);
    } else {
      console.log(`    ${colLetter}5 (ìƒìˆ˜): ë°ì´í„° ì—†ìŒ`);
    }
  });
  
  console.log('\nâœ… ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ');
}

// ========== ì´ ì •ë¦¬ í‘œ ê´€ë ¨ í•¨ìˆ˜ (ê°œì„  ë²„ì „) ==========

// ë©”ë‰´ì—ì„œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜ (ëˆ„ë½ë˜ì—ˆë˜ í•¨ìˆ˜)
function updateSummaryTableOnly() {
  console.log('\n' + '='.repeat(60));
  console.log('ğŸ“Š ===== ì´ ì •ë¦¬ í‘œ ë‹¨ë… ì—…ë°ì´íŠ¸ ì‹œì‘ =====');
  console.log('='.repeat(60));
  
  const ui = SpreadsheetApp.getUi();
  
  // ì‚¬ìš©ìì—ê²Œ ì—…ë°ì´íŠ¸ ë°©ë²• ì„ íƒ ì œê³µ
  const result = ui.alert(
    'ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸',
    'ì—…ë°ì´íŠ¸ ë°©ë²•ì„ ì„ íƒí•˜ì„¸ìš”:\n\n' +
    '[ì˜ˆ] - ê¸°ì¡´ ì‹œíŠ¸ì˜ ì§‘ê³„í‘œì—ì„œ ë°ì´í„° ì¶”ì¶œ\n' +
    '[ì•„ë‹ˆì˜¤] - ì‹œíŠ¸ ì¬ì²˜ë¦¬ í›„ ì—…ë°ì´íŠ¸\n' +
    '[ì·¨ì†Œ] - ì‘ì—… ì·¨ì†Œ',
    ui.ButtonSet.YES_NO_CANCEL
  );
  
  if (result === ui.Button.YES) {
    // ê¸°ì¡´ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ì¶”ì¶œ
    updateSummaryTableFromSheets();
  } else if (result === ui.Button.NO) {
    // ì‹œíŠ¸ ì¬ì²˜ë¦¬ í›„ ì—…ë°ì´íŠ¸
    reprocessAndUpdateSummaryTable();
  } else {
    console.log('ì‚¬ìš©ìê°€ ì·¨ì†Œí•¨');
  }
}

// ì‹œíŠ¸ ì¬ì²˜ë¦¬ í›„ ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸
function reprocessAndUpdateSummaryTable() {
  console.log('\n' + '='.repeat(60));
  console.log('ğŸ”„ ===== ì‹œíŠ¸ ì¬ì²˜ë¦¬ í›„ ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸ =====');
  console.log('='.repeat(60));
  
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const summarySheet = ss.getSheetByName('ì´ ì •ë¦¬ í‘œ');
  
  if (!summarySheet) {
    SpreadsheetApp.getUi().alert('ì´ ì •ë¦¬ í‘œ ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  // 3í–‰ì˜ í—¤ë” ì½ê¸°
  const headers = summarySheet.getRange(3, 2, 1, 3).getValues()[0];
  console.log('\nğŸ“‹ ì´ ì •ë¦¬ í‘œ í—¤ë”:');
  headers.forEach((h, i) => {
    console.log(`  ${String.fromCharCode(66 + i)}3: "${h}"`);
  });
  
  // í—¤ë” íŒŒì‹±
  const headerInfo = parseHeadersImproved(headers);
  
  // ì²˜ë¦¬í•  ì‹œíŠ¸ ì°¾ê¸°
  const sheetsToProcess = findSheetsForHeaders(ss, headerInfo);
  
  if (sheetsToProcess.length === 0) {
    SpreadsheetApp.getUi().alert('ì²˜ë¦¬í•  ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  console.log('\nğŸ“„ ì²˜ë¦¬í•  ì‹œíŠ¸:');
  sheetsToProcess.forEach(s => console.log(`  - ${s.name}`));
  
  // ì‹œíŠ¸ ì²˜ë¦¬
  const processedData = {};
  sheetsToProcess.forEach(sheetInfo => {
    try {
      console.log(`\nì²˜ë¦¬ ì¤‘: ${sheetInfo.name}`);
      const sheet = ss.getSheetByName(sheetInfo.name);
      if (sheet) {
        processedData[sheetInfo.name] = processSheet(sheet);
      }
    } catch (error) {
      console.error(`${sheetInfo.name} ì²˜ë¦¬ ì‹¤íŒ¨: ${error.toString()}`);
    }
  });
  
  // ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸
  updateSummaryTable(processedData);
  
  SpreadsheetApp.getUi().alert('ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// ê°œì„ ëœ í—¤ë” íŒŒì‹± í•¨ìˆ˜
function parseHeadersImproved(headers) {
  const headerInfo = [];
  const currentDate = new Date();
  const currentYear = currentDate.getFullYear();
  
  headers.forEach((header, index) => {
    if (!header) {
      headerInfo.push(null);
      return;
    }
    
    const headerStr = header.toString().trim();
    console.log(`\n  í—¤ë” íŒŒì‹± ì¤‘: "${headerStr}"`);
    
    let parsed = null;
    
    // ë‹¤ì–‘í•œ í˜•ì‹ ì²˜ë¦¬
    // "7ì›”" í˜•ì‹
    if (headerStr.match(/^(\d{1,2})ì›”$/)) {
      const month = parseInt(RegExp.$1);
      // í˜„ì¬ ì›”ë³´ë‹¤ í¬ë©´ ì‘ë…„ìœ¼ë¡œ íŒë‹¨
      const year = month > currentDate.getMonth() + 1 ? currentYear - 1 : currentYear;
      parsed = { year: year, month: month, original: headerStr };
      console.log(`    â†’ ${year}ë…„ ${month}ì›”ë¡œ íŒŒì‹± (ë‹¨ìˆœ ì›”)}`);
    }
    // "24ë…„ 7ì›”" í˜•ì‹
    else if (headerStr.match(/^(\d{2})ë…„\s*(\d{1,2})ì›”$/)) {
      const yearPart = parseInt(RegExp.$1);
      const month = parseInt(RegExp.$2);
      // 2000ë…„ëŒ€ë¡œ ê°€ì •
      const year = yearPart < 50 ? 2000 + yearPart : 1900 + yearPart;
      parsed = { year: year, month: month, original: headerStr };
      console.log(`    â†’ ${year}ë…„ ${month}ì›”ë¡œ íŒŒì‹± (2ìë¦¬ ì—°ë„)`);
    }
    // "2024ë…„ 7ì›”" í˜•ì‹
    else if (headerStr.match(/^(\d{4})ë…„\s*(\d{1,2})ì›”$/)) {
      const year = parseInt(RegExp.$1);
      const month = parseInt(RegExp.$2);
      parsed = { year: year, month: month, original: headerStr };
      console.log(`    â†’ ${year}ë…„ ${month}ì›”ë¡œ íŒŒì‹± (4ìë¦¬ ì—°ë„)`);
    }
    // "2024.7" ë˜ëŠ” "2024/7" í˜•ì‹
    else if (headerStr.match(/^(\d{4})[.\/](\d{1,2})$/)) {
      const year = parseInt(RegExp.$1);
      const month = parseInt(RegExp.$2);
      parsed = { year: year, month: month, original: headerStr };
      console.log(`    â†’ ${year}ë…„ ${month}ì›”ë¡œ íŒŒì‹± (êµ¬ë¶„ì í˜•ì‹)`);
    }
    else {
      console.log(`    â†’ íŒŒì‹± ì‹¤íŒ¨`);
    }
    
    headerInfo.push(parsed);
  });
  
  return headerInfo;
}

// í—¤ë”ì— ë§ëŠ” ì‹œíŠ¸ ì°¾ê¸°
function findSheetsForHeaders(ss, headerInfo) {
  const sheets = [];
  const allSheets = ss.getSheets();
  
  headerInfo.forEach(header => {
    if (!header) return;
    
    // ì¶•ì‚°ê³¼ ìƒìˆ˜ ì‹œíŠ¸ ëª¨ë‘ ì°¾ê¸°
    ['ì¶•ì‚°', 'ìƒìˆ˜'].forEach(type => {
      const sheetName = `${header.year}ë…„ ${header.month}ì›” (${type})`;
      const sheet = allSheets.find(s => {
        const name = s.getName();
        // ì •í™•í•œ ë§¤ì¹­ ë˜ëŠ” ê³µë°± ì°¨ì´ í—ˆìš©
        return name === sheetName || 
               name.replace(/\s+/g, '') === sheetName.replace(/\s+/g, '');
      });
      
      if (sheet) {
        sheets.push({
          name: sheet.getName(),
          year: header.year,
          month: header.month,
          type: type
        });
      }
    });
  });
  
  return sheets;
}

// ê°œì„ ëœ ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateSummaryTable(processedData) {
  console.log('\n' + '='.repeat(60));
  console.log('ğŸ“Š ===== ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸ ì‹œì‘ =====');
  console.log('='.repeat(60));
  
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let summarySheet = ss.getSheetByName('ì´ ì •ë¦¬ í‘œ');
  
  if (!summarySheet) {
    console.log('âŒ ì´ ì •ë¦¬ í‘œ ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
    SpreadsheetApp.getUi().alert('ì´ ì •ë¦¬ í‘œ ì‹œíŠ¸ë¥¼ ë¨¼ì € ë§Œë“¤ì–´ì£¼ì„¸ìš”.');
    return;
  }
  
  console.log('âœ… ì´ ì •ë¦¬ í‘œ ì‹œíŠ¸ ë°œê²¬');
  
  // 3í–‰ì˜ í—¤ë” ì½ê¸° (B3:D3)
  const headers = summarySheet.getRange(3, 2, 1, 3).getValues()[0];
  console.log('\nğŸ“‹ ì´ ì •ë¦¬ í‘œ í—¤ë” í™•ì¸:');
  console.log(`  B3: "${headers[0]}"`);
  console.log(`  C3: "${headers[1]}"`);
  console.log(`  D3: "${headers[2]}"`);
  
  // í—¤ë”ì—ì„œ ì›” ì •ë³´ íŒŒì‹±
  const headerInfo = parseHeadersImproved(headers);
  console.log('\nğŸ“… íŒŒì‹±ëœ í—¤ë” ì •ë³´:');
  headerInfo.forEach((info, index) => {
    const col = String.fromCharCode(66 + index); // B, C, D
    if (info) {
      console.log(`  ${col}ì—´: ${info.year}ë…„ ${info.month}ì›”`);
    } else {
      console.log(`  ${col}ì—´: íŒŒì‹± ì‹¤íŒ¨`);
    }
  });
  
  // ì²˜ë¦¬ëœ ë°ì´í„°ì—ì„œ ì‹¤ì œ ì‹œíŠ¸ ì •ë³´ ìˆ˜ì§‘
  const sheetDataMap = collectSheetDataImproved(processedData);
  console.log('\nğŸ“Š ìˆ˜ì§‘ëœ ì‹œíŠ¸ ë°ì´í„°:');
  Object.keys(sheetDataMap).forEach(key => {
    const data = sheetDataMap[key];
    if (data) {
      console.log(`  ${key}: ${data.totalMinutes}ë¶„ = ${data.totalHours}ì‹œê°„`);
    } else {
      console.log(`  ${key}: ë°ì´í„° ì—†ìŒ`);
    }
  });
  
  // B4:D5 ì˜ì—­ ì—…ë°ì´íŠ¸
  console.log('\nğŸ”„ ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹œì‘...');
  updateSummaryDataImproved(summarySheet, headerInfo, sheetDataMap);
  
  console.log('\n' + '='.repeat(60));
  console.log('âœ… ===== ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸ ì™„ë£Œ =====');
  console.log('='.repeat(60));
}

// ê°œì„ ëœ ì‹œíŠ¸ ë°ì´í„° ìˆ˜ì§‘ í•¨ìˆ˜
function collectSheetDataImproved(processedData) {
  const sheetDataMap = {};
  
  console.log('\nğŸ“ˆ ì‹œíŠ¸ë³„ ë°ì´í„° ìˆ˜ì§‘ ì¤‘...');
  
  Object.keys(processedData).forEach(sheetName => {
    console.log(`\n  ì‹œíŠ¸: ${sheetName}`);
    
    const match = sheetName.match(/^(\d{4})ë…„\s*(\d+)ì›”\s*\((ì¶•ì‚°|ìƒìˆ˜)\)$/);
    if (match) {
      const year = parseInt(match[1]);
      const month = parseInt(match[2]);
      const type = match[3];
      
      // processedDataì—ì„œ í•©ê³„ ê³„ì‚°
      const totalMinutes = calculateTotalMinutes(processedData[sheetName]);
      const totalHours = Math.round(totalMinutes / 60); // ì •ìˆ˜ë¡œ ë°˜ì˜¬ë¦¼
      
      const key = `${year}-${month}-${type}`;
      sheetDataMap[key] = {
        sheetName: sheetName,
        year: year,
        month: month,
        type: type,
        totalMinutes: totalMinutes,
        totalHours: totalHours
      };
      
      console.log(`    â†’ í‚¤: ${key}`);
      console.log(`    â†’ ì´ ì‹œê°„: ${totalMinutes}ë¶„ = ${totalHours}ì‹œê°„`);
    } else {
      console.log(`    â†’ ì‹œíŠ¸ëª… í˜•ì‹ì´ ë§ì§€ ì•ŠìŒ`);
    }
  });
  
  return sheetDataMap;
}

// ê°œì„ ëœ ì´ ì •ë¦¬ í‘œ ë°ì´í„° ì—…ë°ì´íŠ¸
function updateSummaryDataImproved(sheet, headerInfo, sheetDataMap) {
  console.log('\nğŸ“ ì…€ ì—…ë°ì´íŠ¸ ì¤‘...');
  
  // B4:D5 ì´ˆê¸°í™”
  sheet.getRange('B4:D5').clearContent();
  console.log('  âœ… B4:D5 ì˜ì—­ ì´ˆê¸°í™” ì™„ë£Œ');
  
  // ê° ì—´ë³„ë¡œ ì²˜ë¦¬
  headerInfo.forEach((header, colIndex) => {
    if (!header) {
      console.log(`\n  âš ï¸ ${String.fromCharCode(66 + colIndex)}ì—´: í—¤ë” ì •ë³´ ì—†ìŒ - ê±´ë„ˆëœ€`);
      return;
    }
    
    const col = colIndex + 2; // B=2, C=3, D=4
    const colLetter = String.fromCharCode(66 + colIndex);
    
    console.log(`\n  ğŸ“Œ ${colLetter}ì—´ ì²˜ë¦¬ (${header.year}ë…„ ${header.month}ì›”):`);
    
    // ì¶•ì‚° ë°ì´í„° (4í–‰)
    const livestockKey = `${header.year}-${header.month}-ì¶•ì‚°`;
    if (sheetDataMap[livestockKey]) {
      const value = sheetDataMap[livestockKey].totalHours;
      sheet.getRange(4, col).setValue(value);
      console.log(`    âœ… ${colLetter}4 (ì¶•ì‚°): ${value}ì‹œê°„ ì…ë ¥ ì™„ë£Œ`);
    } else {
      sheet.getRange(4, col).setValue(0);
      console.log(`    âš ï¸ ${colLetter}4 (ì¶•ì‚°): ë°ì´í„° ì—†ìŒ â†’ 0 ì…ë ¥`);
    }
    
    // ìƒìˆ˜ ë°ì´í„° (5í–‰)
    const waterKey = `${header.year}-${header.month}-ìƒìˆ˜`;
    if (sheetDataMap[waterKey]) {
      const value = sheetDataMap[waterKey].totalHours;
      sheet.getRange(5, col).setValue(value);
      console.log(`    âœ… ${colLetter}5 (ìƒìˆ˜): ${value}ì‹œê°„ ì…ë ¥ ì™„ë£Œ`);
    } else {
      sheet.getRange(5, col).setValue(0);
      console.log(`    âš ï¸ ${colLetter}5 (ìƒìˆ˜): ë°ì´í„° ì—†ìŒ â†’ 0 ì…ë ¥`);
    }
  });
  
  // ì„œì‹ ì ìš©
  const dataRange = sheet.getRange('B4:D5');
  dataRange.setNumberFormat('#,##0'); // ì²œ ë‹¨ìœ„ êµ¬ë¶„
  dataRange.setHorizontalAlignment('center');
  dataRange.setFontFamily('Malgun Gothic');
  dataRange.setFontSize(11);
  
  console.log('\nâœ… ë°ì´í„° ì—…ë°ì´íŠ¸ ë° ì„œì‹ ì ìš© ì™„ë£Œ');
}

// ê¸°ì¡´ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ì¶”ì¶œí•˜ì—¬ ì—…ë°ì´íŠ¸ (ê°œì„  ë²„ì „)
function updateSummaryTableFromSheets() {
  console.log('\n' + '='.repeat(60));
  console.log('ğŸ“Š ===== ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸ (ì‹œíŠ¸ì—ì„œ ì¶”ì¶œ) =====');
  console.log('='.repeat(60));
  
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // ì´ ì •ë¦¬ í‘œ í™•ì¸
  const summarySheet = ss.getSheetByName('ì´ ì •ë¦¬ í‘œ');
  if (!summarySheet) {
    SpreadsheetApp.getUi().alert('ì´ ì •ë¦¬ í‘œ ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  console.log('âœ… ì´ ì •ë¦¬ í‘œ ì‹œíŠ¸ ë°œê²¬');
  
  // 3í–‰ì˜ í—¤ë” ì½ê¸°
  const headers = summarySheet.getRange(3, 2, 1, 3).getValues()[0];
  console.log('\nğŸ“‹ ì´ ì •ë¦¬ í‘œ í—¤ë”:');
  headers.forEach((h, i) => {
    console.log(`  ${String.fromCharCode(66 + i)}3: "${h}"`);
  });
  
  // í—¤ë” íŒŒì‹±
  const headerInfo = parseHeadersImproved(headers);
  
  // ëª¨ë“  ì‹œíŠ¸ ê²€ìƒ‰
  const allSheets = ss.getSheets();
  const sheetDataMap = {};
  
  console.log('\nğŸ” ì‹œíŠ¸ ê²€ìƒ‰ ë° ë°ì´í„° ì¶”ì¶œ...');
  
  allSheets.forEach(sheet => {
    const sheetName = sheet.getName();
    const match = sheetName.match(/^(\d{4})ë…„\s*(\d+)ì›”\s*\((ì¶•ì‚°|ìƒìˆ˜)\)$/);
    
    if (match) {
      console.log(`\n  ğŸ“„ ì‹œíŠ¸ ë°œê²¬: ${sheetName}`);
      
      const year = parseInt(match[1]);
      const month = parseInt(match[2]);
      const type = match[3];
      
      // ì‚¬ìœ ë³„ ì§‘ê³„ í‘œì—ì„œ í•©ê³„ ì°¾ê¸°
      const totalMinutes = extractTotalFromSheetImproved(sheet);
      
      if (totalMinutes !== null) {
        const totalHours = Math.round(totalMinutes / 60); // ì •ìˆ˜ë¡œ ë°˜ì˜¬ë¦¼
        const key = `${year}-${month}-${type}`;
        
        sheetDataMap[key] = {
          sheetName: sheetName,
          year: year,
          month: month,
          type: type,
          totalMinutes: totalMinutes,
          totalHours: totalHours
        };
        
        console.log(`    âœ… í•©ê³„ ì¶”ì¶œ ì„±ê³µ: ${totalMinutes}ë¶„ = ${totalHours}ì‹œê°„`);
      } else {
        console.log(`    âŒ í•©ê³„ ì¶”ì¶œ ì‹¤íŒ¨`);
      }
    }
  });
  
  // ë°ì´í„° ì—…ë°ì´íŠ¸
  console.log('\nğŸ“ ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸ ì¤‘...');
  updateSummaryDataImproved(summarySheet, headerInfo, sheetDataMap);
  
  console.log('\n' + '='.repeat(60));
  console.log('âœ… ===== ì—…ë°ì´íŠ¸ ì™„ë£Œ =====');
  console.log('='.repeat(60));
  
  SpreadsheetApp.getUi().alert('ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
}

// ê°œì„ ëœ ì‹œíŠ¸ì—ì„œ í•©ê³„ ì¶”ì¶œ í•¨ìˆ˜
function extractTotalFromSheetImproved(sheet) {
  const sheetName = sheet.getName();
  console.log(`    ğŸ” "${sheetName}"ì—ì„œ í•©ê³„ ì°¾ëŠ” ì¤‘...`);
  
  try {
    const data = sheet.getDataRange().getValues();
    
    // "ì‚¬ìœ ë³„ ì§‘ê³„" ì°¾ê¸°
    let summaryStartRow = -1;
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] && data[i][0].toString().includes('ì‚¬ìœ ë³„ ì§‘ê³„')) {
        summaryStartRow = i;
        console.log(`      â†’ "ì‚¬ìœ ë³„ ì§‘ê³„" ë°œê²¬: ${i + 1}í–‰`);
        break;
      }
    }
    
    if (summaryStartRow === -1) {
      console.log(`      â†’ "ì‚¬ìœ ë³„ ì§‘ê³„" ì°¾ì§€ ëª»í•¨`);
      return null;
    }
    
    // í—¤ë” í–‰ í™•ì¸ (ì‚¬ìœ ë³„ ì§‘ê³„ ë‹¤ìŒ í–‰)
    const headerRow = summaryStartRow + 1;
    if (headerRow >= data.length) {
      console.log(`      â†’ í—¤ë” í–‰ ì—†ìŒ`);
      return null;
    }
    
    // "ê²°ê³¼ì‹œê°„" ì—´ ì°¾ê¸°
    let resultCol = -1;
    const headerData = data[headerRow];
    for (let j = 0; j < headerData.length; j++) {
      if (headerData[j] && headerData[j].toString().includes('ê²°ê³¼ì‹œê°„')) {
        resultCol = j;
        console.log(`      â†’ "ê²°ê³¼ì‹œê°„" ì—´ ë°œê²¬: ${String.fromCharCode(65 + j)}ì—´ (${j + 1}ë²ˆì§¸)`);
        break;
      }
    }
    
    if (resultCol === -1) {
      console.log(`      â†’ "ê²°ê³¼ì‹œê°„" ì—´ ì°¾ì§€ ëª»í•¨`);
      return null;
    }
    
    // "í•©ê³„" í–‰ ì°¾ê¸° (ì‚¬ìœ ë³„ ì§‘ê³„ í…Œì´ë¸” ë²”ìœ„ ë‚´ì—ì„œë§Œ)
    const maxSearchRows = 50; // ìµœëŒ€ 50í–‰ê¹Œì§€ë§Œ ê²€ìƒ‰
    for (let i = headerRow + 1; i < Math.min(headerRow + maxSearchRows, data.length); i++) {
      if (data[i][0] && data[i][0].toString().trim() === 'í•©ê³„') {
        const totalValue = data[i][resultCol];
        console.log(`      â†’ "í•©ê³„" í–‰ ë°œê²¬: ${i + 1}í–‰`);
        console.log(`      â†’ ê²°ê³¼ì‹œê°„ ê°’: ${totalValue}`);
        
        if (totalValue !== null && totalValue !== '' && !isNaN(totalValue)) {
          const minutes = parseFloat(totalValue);
          console.log(`      â†’ íŒŒì‹±ëœ ê°’: ${minutes}ë¶„`);
          return minutes;
        } else {
          console.log(`      â†’ ê°’ì´ ìœ íš¨í•˜ì§€ ì•ŠìŒ: "${totalValue}"`);
        }
      }
    }
    
    console.log(`      â†’ "í•©ê³„" í–‰ ì°¾ì§€ ëª»í•¨`);
    return null;
    
  } catch (error) {
    console.error(`      â†’ ì˜¤ë¥˜ ë°œìƒ: ${error.toString()}`);
    return null;
  }
}

// ë””ë²„ê¹…ìš©: ì´ ì •ë¦¬ í‘œ ìƒíƒœ í™•ì¸
function debugSummaryTableStatus() {
  console.log('\n' + '='.repeat(60));
  console.log('ğŸ” ===== ì´ ì •ë¦¬ í‘œ ìƒíƒœ í™•ì¸ =====');
  console.log('='.repeat(60));
  
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const summarySheet = ss.getSheetByName('ì´ ì •ë¦¬ í‘œ');
  
  if (!summarySheet) {
    console.log('âŒ ì´ ì •ë¦¬ í‘œ ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  // í—¤ë” í™•ì¸
  const headers = summarySheet.getRange(3, 2, 1, 3).getValues()[0];
  console.log('\nğŸ“‹ í˜„ì¬ í—¤ë”:');
  headers.forEach((h, i) => {
    const col = String.fromCharCode(66 + i);
    console.log(`  ${col}3: "${h}"`);
  });
  
  // í˜„ì¬ ë°ì´í„° í™•ì¸
  const currentData = summarySheet.getRange(4, 2, 2, 3).getValues();
  console.log('\nğŸ“Š í˜„ì¬ ë°ì´í„°:');
  console.log('  ì¶•ì‚° (4í–‰): B4=' + currentData[0][0] + ', C4=' + currentData[0][1] + ', D4=' + currentData[0][2]);
  console.log('  ìƒìˆ˜ (5í–‰): B5=' + currentData[1][0] + ', C5=' + currentData[1][1] + ', D5=' + currentData[1][2]);
  
  // íŒŒì‹± í…ŒìŠ¤íŠ¸
  console.log('\nğŸ”§ í—¤ë” íŒŒì‹± í…ŒìŠ¤íŠ¸:');
  const headerInfo = parseHeadersImproved(headers);
  headerInfo.forEach((info, i) => {
    const col = String.fromCharCode(66 + i);
    if (info) {
      console.log(`  ${col}ì—´: ${info.year}ë…„ ${info.month}ì›”`);
    } else {
      console.log(`  ${col}ì—´: íŒŒì‹± ì‹¤íŒ¨`);
    }
  });
  
  // ì‚¬ìš© ê°€ëŠ¥í•œ ì‹œíŠ¸ í™•ì¸
  console.log('\nğŸ“„ ì‚¬ìš© ê°€ëŠ¥í•œ ì‹œíŠ¸:');
  const allSheets = ss.getSheets();
  const availableSheets = [];
  
  allSheets.forEach(sheet => {
    const sheetName = sheet.getName();
    if (sheetName.match(/^(\d{4})ë…„\s*(\d+)ì›”\s*\((ì¶•ì‚°|ìƒìˆ˜)\)$/)) {
      availableSheets.push(sheetName);
      
      // í•´ë‹¹ ì‹œíŠ¸ì˜ ì§‘ê³„ ë°ì´í„° í™•ì¸
      const total = extractTotalFromSheetImproved(sheet);
      if (total !== null) {
        const hours = Math.round(total / 60);
        console.log(`  âœ… ${sheetName}: ${total}ë¶„ = ${hours}ì‹œê°„`);
      } else {
        console.log(`  âš ï¸ ${sheetName}: ì§‘ê³„ ë°ì´í„° ì—†ìŒ`);
      }
    }
  });
  
  if (availableSheets.length === 0) {
    console.log('  âŒ ì‚¬ìš© ê°€ëŠ¥í•œ ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
  }
  
  console.log('\n' + '='.repeat(60));
  console.log('âœ… ===== ìƒíƒœ í™•ì¸ ì™„ë£Œ =====');
  console.log('='.repeat(60));
}

// ========== ë³„ë„ ì‹¤í–‰ìš©: ê¸°ì¡´ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ì¶”ì¶œ ==========

// ì´ ì •ë¦¬ í‘œë§Œ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ì‹œíŠ¸ì˜ ì§‘ê³„í‘œì—ì„œ ë°ì´í„° ì¶”ì¶œ)
function updateSummaryTableFromSheets() {
  console.log('\n' + '='.repeat(60));
  console.log('===== ì´ ì •ë¦¬ í‘œ ë‹¨ë… ì—…ë°ì´íŠ¸ (ì‹œíŠ¸ì—ì„œ ì¶”ì¶œ) =====');
  console.log('='.repeat(60));
  
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // ì´ ì •ë¦¬ í‘œ í™•ì¸
  const summarySheet = ss.getSheetByName('ì´ ì •ë¦¬ í‘œ');
  if (!summarySheet) {
    SpreadsheetApp.getUi().alert('ì´ ì •ë¦¬ í‘œ ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  console.log('âœ… ì´ ì •ë¦¬ í‘œ ì‹œíŠ¸ ë°œê²¬');
  
  // 3í–‰ì˜ í—¤ë” ì½ê¸°
  const headers = summarySheet.getRange(3, 2, 1, 3).getValues()[0];
  console.log('\nğŸ“‹ ì´ ì •ë¦¬ í‘œ í—¤ë”:');
  headers.forEach((h, i) => {
    console.log(`  ${String.fromCharCode(66 + i)}3: "${h}"`);
  });
  
  // í—¤ë” íŒŒì‹±
  const headerInfo = parseHeadersImproved(headers);
  
  // ëª¨ë“  ì‹œíŠ¸ ê²€ìƒ‰
  const allSheets = ss.getSheets();
  const sheetDataMap = {};
  
  console.log('\nğŸ” ì‹œíŠ¸ ê²€ìƒ‰ ë° ë°ì´í„° ì¶”ì¶œ...');
  
  allSheets.forEach(sheet => {
    const sheetName = sheet.getName();
    const match = sheetName.match(/^(\d{4})ë…„\s*(\d+)ì›”\s*\((ì¶•ì‚°|ìƒìˆ˜)\)$/);
    
    if (match) {
      console.log(`\n  ğŸ“„ ì‹œíŠ¸ ë°œê²¬: ${sheetName}`);
      
      const year = parseInt(match[1]);
      const month = parseInt(match[2]);
      const type = match[3];
      
      // ì‚¬ìœ ë³„ ì§‘ê³„ í‘œì—ì„œ í•©ê³„ ì°¾ê¸°
      const totalMinutes = extractTotalFromSheet(sheet);
      
      if (totalMinutes !== null) {
        const totalHours = Math.round(totalMinutes / 60 * 10) / 10;
        const key = `${year}-${month}-${type}`;
        
        sheetDataMap[key] = {
          sheetName: sheetName,
          year: year,
          month: month,
          type: type,
          totalMinutes: totalMinutes,
          totalHours: totalHours
        };
        
        console.log(`    âœ… í•©ê³„ ì¶”ì¶œ ì„±ê³µ: ${totalMinutes}ë¶„ = ${totalHours}ì‹œê°„`);
      } else {
        console.log(`    âŒ í•©ê³„ ì¶”ì¶œ ì‹¤íŒ¨`);
      }
    }
  });
  
  // ë°ì´í„° ì—…ë°ì´íŠ¸
  console.log('\nğŸ“ ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸ ì¤‘...');
  updateSummaryData(summarySheet, headerInfo, sheetDataMap);
  
  console.log('\n' + '='.repeat(60));
  console.log('===== ì—…ë°ì´íŠ¸ ì™„ë£Œ =====');
  console.log('='.repeat(60));
  
  SpreadsheetApp.getUi().alert('ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
}

// ì‹œíŠ¸ì—ì„œ ì‚¬ìœ ë³„ ì§‘ê³„ í•©ê³„ ì¶”ì¶œ
function extractTotalFromSheet(sheet) {
  console.log(`    ğŸ” "${sheet.getName()}"ì—ì„œ í•©ê³„ ì°¾ëŠ” ì¤‘...`);
  
  const data = sheet.getDataRange().getValues();
  
  // "ì‚¬ìœ ë³„ ì§‘ê³„" ì°¾ê¸°
  let summaryStartRow = -1;
  for (let i = 0; i < data.length; i++) {
    if (data[i][0] && data[i][0].toString().includes('ì‚¬ìœ ë³„ ì§‘ê³„')) {
      summaryStartRow = i;
      console.log(`      â†’ "ì‚¬ìœ ë³„ ì§‘ê³„" ë°œê²¬: ${i + 1}í–‰`);
      break;
    }
  }
  
  if (summaryStartRow === -1) {
    console.log(`      â†’ "ì‚¬ìœ ë³„ ì§‘ê³„" ì°¾ì§€ ëª»í•¨`);
    return null;
  }
  
  // í—¤ë” í–‰ í™•ì¸ (ì‚¬ìœ ë³„ ì§‘ê³„ ë‹¤ìŒ í–‰)
  const headerRow = summaryStartRow + 1;
  if (headerRow >= data.length) {
    console.log(`      â†’ í—¤ë” í–‰ ì—†ìŒ`);
    return null;
  }
  
  // "ê²°ê³¼ì‹œê°„" ì—´ ì°¾ê¸°
  let resultCol = -1;
  const headerData = data[headerRow];
  for (let j = 0; j < headerData.length; j++) {
    if (headerData[j] && headerData[j].toString().includes('ê²°ê³¼ì‹œê°„')) {
      resultCol = j;
      console.log(`      â†’ "ê²°ê³¼ì‹œê°„" ì—´ ë°œê²¬: ${j + 1}ë²ˆì§¸ ì—´`);
      break;
    }
  }
  
  if (resultCol === -1) {
    console.log(`      â†’ "ê²°ê³¼ì‹œê°„" ì—´ ì°¾ì§€ ëª»í•¨`);
    return null;
  }
  
  // "í•©ê³„" í–‰ ì°¾ê¸°
  for (let i = headerRow + 1; i < data.length; i++) {
    if (data[i][0] && data[i][0].toString() === 'í•©ê³„') {
      const totalValue = data[i][resultCol];
      console.log(`      â†’ "í•©ê³„" í–‰ ë°œê²¬: ${i + 1}í–‰`);
      console.log(`      â†’ ê²°ê³¼ì‹œê°„ ê°’: ${totalValue}ë¶„`);
      
      if (totalValue && !isNaN(totalValue)) {
        return parseFloat(totalValue);
      }
    }
  }
  
  console.log(`      â†’ "í•©ê³„" í–‰ ì°¾ì§€ ëª»í•¨`);
  return null;
}

// ========== í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ ==========

// ì´ ì •ë¦¬ í‘œ í…ŒìŠ¤íŠ¸
function testSummaryTableUpdate() {
  console.log('\n' + '='.repeat(60));
  console.log('===== ì´ ì •ë¦¬ í‘œ í…ŒìŠ¤íŠ¸ =====');
  console.log('='.repeat(60));
  
  // í…ŒìŠ¤íŠ¸ìš© processedData ìƒì„±
  const testData = {
    '2024ë…„ 7ì›” (ì¶•ì‚°)': {
      'ì†¡ì•„ì§€ ë¶„ë§Œ ë° ì²˜ì¹˜': { count: 10, minutes: 885 },
      'í™˜ì¶• ê´€ë¦¬': { count: 13, minutes: 995 },
      'ì¸ê³µìˆ˜ì •': { count: 1, minutes: 60 },
      'ì¸ê³µì ì¶œ': { count: 4, minutes: 422.5 },
      'ì˜ë† ì¥ë¹„ ê¸°ë¦„ ì£¼ìœ ': { count: 1, minutes: 97.5 },
      'ë¶„ë§Œ': { count: 1, minutes: 30 },
      'ì €ì¹˜': { count: 1, minutes: 30 },
      'ê¸°ë¦„ì£¼ìœ ': { count: 1, minutes: 40 }
    },
    '2024ë…„ 6ì›” (ì¶•ì‚°)': {
      'ì˜ë† ì¥ë¹„ ê¸°ë¦„ ì£¼ìœ ': { count: 5, minutes: 320 },
      'ì†¡ì•„ì§€ ë¶„ë§Œ ë° ì²˜ì¹˜': { count: 9, minutes: 552.5 },
      'í™˜ì¶• ê´€ë¦¬': { count: 12, minutes: 957.5 },
      'ì¸ê³µì ì¶œ': { count: 4, minutes: 397.5 },
      'ì‹ ì¶•ì‚¬ ì¶•ìš° ì´ë™': { count: 1, minutes: 97.5 }
    },
    '2024ë…„ 7ì›” (ìƒìˆ˜)': {
      '0.5L ì œí’ˆìƒì‚°': { count: 10, minutes: 600 },
      '1.5L BTLìƒì‚°': { count: 8, minutes: 480 },
      'ìƒì‚°ì„¤ë¹„ ì •ë¹„': { count: 2, minutes: 120 }
    },
    '2024ë…„ 6ì›” (ìƒìˆ˜)': {
      '0.5L ì œí’ˆìƒì‚°': { count: 8, minutes: 480 },
      '1.5L BTLìƒì‚°': { count: 6, minutes: 360 }
    }
  };
  
  console.log('\nğŸ“Š í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ');
  
  // ê° ì‹œíŠ¸ì˜ í•©ê³„ ê³„ì‚°
  Object.keys(testData).forEach(sheetName => {
    const total = calculateTotalMinutes(testData[sheetName]);
    const hours = Math.round(total / 60 * 10) / 10;
    console.log(`  ${sheetName}: ${total}ë¶„ = ${hours}ì‹œê°„`);
  });
  
  // ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸
  updateSummaryTable(testData);
  
  console.log('\nâœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ');
}

// ë””ë²„ê¹…: íŠ¹ì • ì‹œíŠ¸ì˜ ì§‘ê³„í‘œ í™•ì¸
function debugSheetSummary(sheetName) {
  console.log(`\n===== ${sheetName} ì§‘ê³„í‘œ ë””ë²„ê¹… =====`);
  
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(sheetName);
  
  if (!sheet) {
    console.log('ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  const total = extractTotalFromSheet(sheet);
  if (total !== null) {
    const hours = Math.round(total / 60 * 10) / 10;
    console.log(`\nâœ… ìµœì¢… ê²°ê³¼: ${total}ë¶„ = ${hours}ì‹œê°„`);
  } else {
    console.log('\nâŒ í•©ê³„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }
}

// ========== UI ê´€ë ¨ í•¨ìˆ˜ ==========

function onOpen() {
  const ui = SpreadsheetApp.getUi();

  // ë©”ì¸ ë©”ë‰´
  const menu = ui.createMenu('ì—°ì¥ê·¼ë¬´ ê´€ë¦¬');

  // [1] ë¹„êµë¶„ì„ ì„œë¸Œë©”ë‰´
  const analysisMenu = ui.createMenu('ë¹„êµë¶„ì„')
    .addItem('ë¹„êµë¶„ì„ ì‹¤ì‹œ', 'runMonthlyClosing')
    .addItem('ì‹œíŠ¸ ì„ íƒí•˜ì—¬ ë¶„ì„', 'showAnalysisDialog')
    .addItem('ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸', 'updateSummaryTableOnly')
    .addItem('ì—‘ì…€ íŒŒì¼ ì—…ë¡œë”', 'showExcelUploader');

  // [2] ì—°ì¥ê·¼ë¡œ ë³´ê³ ì„œ ì„œë¸Œë©”ë‰´
  const reportMenu = ui.createMenu('ì—°ì¥ê·¼ë¡œ ë³´ê³ ì„œ')
    .addItem('ì›”ë³„ ë³´ê³ ì„œ ìƒì„±', 'createMonthlyReport')
    .addItem('ë¶„ê¸°ë³„ ë³´ê³ ì„œ ìƒì„±', 'createQuarterlyReport')
    .addItem('ì—°ê°„ ë³´ê³ ì„œ ìƒì„±', 'createYearlyReport')
    .addSeparator()
    .addItem('ë³´ê³ ì„œ í…œí”Œë¦¿ ì„¤ì •', 'configureReportTemplate')
    .addItem('ğŸ“„ ë³´ê³ ì„œ ìƒì„±', 'generateOvertimeReport') // ë‘ ê³³ì—ì„œ ì¤‘ë³µ í•„ìš”ì—†ìœ¼ë©´ í•˜ë‚˜ë§Œ ë“±ë¡
    .addSeparator()
    .addItem('âš™ï¸ ì„¤ì •', 'showSettings');

  // [3] ë°ì´í„° ê´€ë¦¬ ì„œë¸Œë©”ë‰´
  const dataMenu = ui.createMenu('ë°ì´í„° ê´€ë¦¬')
    .addItem('ì„ íƒ ì‹œíŠ¸ ë°ì´í„° ì‚­ì œ', 'showDeleteSheetsDialog')
    .addItem('ëª¨ë“  ì‹œíŠ¸ ë°ì´í„° ì´ˆê¸°í™”', 'deleteAllSheetsData')
    .addItem('ë¹ˆ í–‰ ì •ë¦¬', 'cleanupEmptyRows')
    .addSeparator()
    .addSubMenu(ui.createMenu('ë‚ ì§œ í˜•ì‹ ê´€ë¦¬')
      .addItem('ë‚ ì§œ í˜•ì‹ ìˆ˜ì • (No ì—´)', 'fixAllSheetsDateFormat')
      .addItem('ë‚ ì§œ í‘œì‹œ í˜•ì‹ ìˆ˜ì •', 'fixAllDateDisplayFormat')
      .addItem('ë‚ ì§œ í˜•ì‹ ê²€ì¦', 'validateAllSheetsDateFormat')
      .addItem('ë‚ ì§œ ë¬¸ì œ ë¹ ë¥¸ ìˆ˜ì •', 'quickFixDateIssues')
      .addItem('í†µí•© ë‚ ì§œ ìˆ˜ì • (ëª¨ë“  ë¬¸ì œ)', 'fixAllDateIssues'));

  // [4] ë””ë²„ê¹… ë„êµ¬ ì„œë¸Œë©”ë‰´
  const debugMenu = ui.createMenu('ë””ë²„ê¹… ë„êµ¬')
    .addItem('ì „ì²´ ê³¼ì • í…ŒìŠ¤íŠ¸', 'testFullProcess')
    .addItem('ì‹œíŠ¸ ì •ë³´ í™•ì¸', 'showDebugSheetInfo')
    .addItem('ì´ ì •ë¦¬ í‘œ í…ŒìŠ¤íŠ¸', 'testSummaryTableUpdate')
    .addItem('ì‹œíŠ¸ ì§‘ê³„í‘œ í™•ì¸', 'showDebugSheetSummary');

  // [5] ë©”ë‰´ì— ì„œë¸Œë©”ë‰´ ì¶”ê°€
  menu
    .addSubMenu(analysisMenu)
    .addSubMenu(reportMenu)
    .addSeparator()
    .addSubMenu(dataMenu)
    .addSeparator()
    .addSubMenu(debugMenu)
    .addSeparator()
    .addItem('ë„ì›€ë§', 'showHelp')
    .addToUi();
}

// UI í‘œì‹œ í•¨ìˆ˜
function showAnalysisDialog() {
  const html = HtmlService.createHtmlOutputFromFile('index')
      .setWidth(650)
      .setHeight(600);
  SpreadsheetApp.getUi()
      .showModalDialog(html, 'ì—°ì¥ê·¼ë¬´ ì›”ë§ ë¹„êµë¶„ì„');
}

// UIì—ì„œ í˜¸ì¶œë˜ëŠ” ë¶„ì„ í•¨ìˆ˜
function runAnalysisWithSheets(selectedSheets) {
  try {
    // ì„ íƒëœ ì‹œíŠ¸ë¡œë§Œ ë¶„ì„ ì‹¤í–‰
    const processedData = {};
    let processedCount = 0;
    
    selectedSheets.forEach((sheetName, index) => {
      const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      if (sheet) {
        // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
        updateClientStatus(`${sheetName} ì‹œíŠ¸ ì²˜ë¦¬ ì¤‘...`, Math.round((index) / selectedSheets.length * 60));
        
        processedData[sheetName] = processSheetWithStatus(sheet, sheetName);
        processedCount++;
      }
    });
    
    // ë¹„êµ ë¶„ì„ ë¦¬í¬íŠ¸ ìƒì„±
    if (processedCount >= 2) {
      updateClientStatus('ë¹„êµ ë¶„ì„ ë¦¬í¬íŠ¸ ìƒì„± ì¤‘...', 80);
      createComparisonReport(processedData);
      
      // ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸ ì¶”ê°€
      updateClientStatus('ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸ ì¤‘...', 85);
      try {
        updateSummaryTable(processedData);
      } catch (error) {
        console.error('ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜:', error.toString());
      }
      
      // ì›ë³¸ ë°ì´í„° ì •ë¦¬
      updateClientStatus('ì›ë³¸ ë°ì´í„° ì •ë¦¬ ì¤‘...', 90);
      selectedSheets.forEach(sheetName => {
        const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
        if (sheet) {
          cleanupOriginalData(sheet);
        }
      });
      
      return { success: true, message: 'ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' };
    } else {
      throw new Error('ë¶„ì„í•  ìˆ˜ ìˆëŠ” ì‹œíŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');
    }
    
  } catch (error) {
    throw new Error('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.toString());
  }
}

// ì§„í–‰ ìƒí™©ì„ í‘œì‹œí•˜ë©´ì„œ ì‹œíŠ¸ ì²˜ë¦¬
function processSheetWithStatus(sheet, sheetName) {
  updateClientStatus(`${sheetName}: í—¤ë” ìˆ˜ì • ì¤‘...`, null);
  modifyHeaders(sheet);
  
  updateClientStatus(`${sheetName}: ë³‘í•© ì…€ í•´ì œ ì¤‘...`, null);
  unmergeAllCells(sheet);
  
  updateClientStatus(`${sheetName}: ë¶ˆí•„ìš”í•œ ì…€ ì •ë¦¬ ì¤‘...`, null);
  deleteUnnecessaryCells(sheet);
  
  updateClientStatus(`${sheetName}: ì—´ ì¶”ê°€ ì¤‘...`, null);
  insertReasonColumns(sheet);
  
  updateClientStatus(`${sheetName}: ì‹œê°„ í˜•ì‹ ë³€í™˜ ì¤‘...`, null);
  convertTimeFormat(sheet);
  
  updateClientStatus(`${sheetName}: ì‹ ì²­ì‚¬ìœ  í‘œì¤€í™” ì¤‘...`, null);
  standardizeAndSplitReasons(sheet);
  
  updateClientStatus(`${sheetName}: í…Œë‘ë¦¬ ì ìš© ì¤‘...`, null);
  addBorderToOriginalData(sheet);
  
  updateClientStatus(`${sheetName}: ì‚¬ìœ ë³„ ì§‘ê³„ ì¤‘...`, null);
  const summary = distributeAndSummarize(sheet);
  
  return summary;
}

// í´ë¼ì´ì–¸íŠ¸ì— ìƒíƒœ ì—…ë°ì´íŠ¸ ì „ì†¡
function updateClientStatus(message, progress) {
  // ìºì‹œë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒíƒœ ì €ì¥
  const cache = CacheService.getUserCache();
  cache.put('analysisStatus', JSON.stringify({
    message: message,
    progress: progress,
    timestamp: new Date().getTime()
  }), 300); // 5ë¶„ê°„ ìœ ì§€
}

// í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìƒíƒœ í™•ì¸
function getAnalysisStatus() {
  const cache = CacheService.getUserCache();
  const status = cache.get('analysisStatus');
  return status ? JSON.parse(status) : null;
}

// ë¶„ì„ ê°€ëŠ¥í•œ ì‹œíŠ¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
function getAnalyzableSheets() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const allSheets = ss.getSheets();
  const analyzableSheets = [];
  
  // ë¶„ì„ ê°€ëŠ¥í•œ ì‹œíŠ¸ íŒ¨í„´
  const patterns = [
    /^\d{4}ë…„\s*\d{1,2}ì›”\s*\(ì¶•ì‚°\)$/,
    /^\d{4}ë…„\s*\d{1,2}ì›”\s*\(ìƒìˆ˜\)$/
  ];
  
  allSheets.forEach(sheet => {
    const sheetName = sheet.getName();
    // íŒ¨í„´ì— ë§ëŠ” ì‹œíŠ¸ë§Œ í¬í•¨
    if (patterns.some(pattern => pattern.test(sheetName))) {
      analyzableSheets.push({
        name: sheetName,
        type: sheetName.includes('ì¶•ì‚°') ? 'ì¶•ì‚°' : 'ìƒìˆ˜',
        year: parseInt(sheetName.match(/(\d{4})ë…„/)[1]),
        month: parseInt(sheetName.match(/(\d{1,2})ì›”/)[1])
      });
    }
  });
  
  // ë‚ ì§œ ìˆœìœ¼ë¡œ ì •ë ¬ (ìµœì‹ ìˆœ)
  analyzableSheets.sort((a, b) => {
    if (a.year !== b.year) return b.year - a.year;
    return b.month - a.month;
  });
  
  return analyzableSheets;
}

// ëª¨ë“  ì‹œíŠ¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ì‚­ì œìš©)
function getAllSheets() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = ss.getSheets();
  
  return sheets.map(sheet => ({
    name: sheet.getName()
  }));
}

// ========== ë°ì´í„° ê´€ë¦¬ í•¨ìˆ˜ (ì´ ì •ë¦¬ í‘œ ë³´í˜¸) ==========

// ëª¨ë“  ì‹œíŠ¸ì˜ ë°ì´í„° ì´ˆê¸°í™” - ì´ ì •ë¦¬ í‘œëŠ” ì œì™¸
function deleteAllSheetsData() {
  const ui = SpreadsheetApp.getUi();
  const result = ui.alert(
    'ê²½ê³ ',
    'ëª¨ë“  ì‹œíŠ¸ì˜ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.\n(ì´ ì •ë¦¬ í‘œëŠ” ì œì™¸)\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
    ui.ButtonSet.YES_NO
  );
  
  if (result !== ui.Button.YES) {
    return;
  }
  
  console.log('ëª¨ë“  ì‹œíŠ¸ ë°ì´í„° ì´ˆê¸°í™” ì‹œì‘ (ì´ ì •ë¦¬ í‘œ ì œì™¸)');
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = ss.getSheets();
  
  // ë³´í˜¸í•  ì‹œíŠ¸ ëª©ë¡
  const protectedSheets = ['ì´ ì •ë¦¬ í‘œ'];
  
  let deletedCount = 0;
  let skippedCount = 0;
  
  sheets.forEach(sheet => {
    try {
      const sheetName = sheet.getName();
      
      // ë³´í˜¸ ì‹œíŠ¸ì¸ì§€ í™•ì¸
      if (protectedSheets.includes(sheetName)) {
        console.log(`${sheetName} ì‹œíŠ¸ëŠ” ë³´í˜¸ë¨ - ê±´ë„ˆëœ€`);
        skippedCount++;
        return;
      }
      
      console.log(`${sheetName} ì‹œíŠ¸ ì´ˆê¸°í™” ì¤‘`);
      sheet.clear();
      deletedCount++;
      console.log(`${sheetName} ì‹œíŠ¸ ì´ˆê¸°í™” ì™„ë£Œ`);
      
    } catch (error) {
      console.error(`ì‹œíŠ¸ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜: ${error.toString()}`);
    }
  });
  
  ui.alert(`${deletedCount}ê°œ ì‹œíŠ¸ì˜ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\n${skippedCount}ê°œ ì‹œíŠ¸ëŠ” ë³´í˜¸ë˜ì–´ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤.`);
}

// ì„ íƒí•œ ì‹œíŠ¸ë“¤ì˜ ë°ì´í„° ì‚­ì œ - ì´ ì •ë¦¬ í‘œëŠ” ì„ íƒ ë¶ˆê°€
function deleteSheetsData(selectedSheets) {
  console.log('ì„ íƒí•œ ì‹œíŠ¸ ë°ì´í„° ì‚­ì œ ì‹œì‘');
  
  // ë³´í˜¸ ì‹œíŠ¸ í•„í„°ë§
  const protectedSheets = ['ì´ ì •ë¦¬ í‘œ'];
  const filteredSheets = selectedSheets.filter(name => !protectedSheets.includes(name));
  
  if (filteredSheets.length < selectedSheets.length) {
    const protectedCount = selectedSheets.length - filteredSheets.length;
    console.log(`${protectedCount}ê°œ ë³´í˜¸ ì‹œíŠ¸ëŠ” ì œì™¸ë¨`);
  }
  
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let deletedCount = 0;
  
  filteredSheets.forEach(sheetName => {
    try {
      console.log(`${sheetName} ì‹œíŠ¸ ì‚­ì œ ì‹œë„`);
      const sheet = ss.getSheetByName(sheetName);
      if (sheet) {
        sheet.clear();
        deletedCount++;
        console.log(`${sheetName} ì‹œíŠ¸ ë°ì´í„° ì‚­ì œ ì™„ë£Œ`);
      } else {
        console.log(`${sheetName} ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
      }
    } catch (error) {
      console.error(`${sheetName} ì‹œíŠ¸ ì‚­ì œ ì¤‘ ì˜¤ë¥˜: ${error.toString()}`);
    }
  });
  
  return {
    success: true,
    message: `${deletedCount}ê°œ ì‹œíŠ¸ì˜ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`
  };
}

// ë¹ˆ í–‰ ì •ë¦¬ - ì´ ì •ë¦¬ í‘œëŠ” ì œì™¸
function cleanupEmptyRows() {
  const ui = SpreadsheetApp.getUi();
  const result = ui.alert(
    'ë¹ˆ í–‰ ì •ë¦¬',
    'ëª¨ë“  ì‹œíŠ¸ì—ì„œ ë¹ˆ í–‰ì„ ì •ë¦¬í•©ë‹ˆë‹¤.\n(ì´ ì •ë¦¬ í‘œëŠ” ì œì™¸)\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
    ui.ButtonSet.YES_NO
  );
  
  if (result !== ui.Button.YES) {
    return;
  }
  
  console.log('ë¹ˆ í–‰ ì •ë¦¬ ì‹œì‘');
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = ss.getSheets();
  
  // ë³´í˜¸ ì‹œíŠ¸
  const protectedSheets = ['ì´ ì •ë¦¬ í‘œ'];
  
  let totalRemoved = 0;
  
  sheets.forEach(sheet => {
    try {
      const sheetName = sheet.getName();
      
      // ë³´í˜¸ ì‹œíŠ¸ëŠ” ê±´ë„ˆë›°ê¸°
      if (protectedSheets.includes(sheetName)) {
        console.log(`${sheetName} ì‹œíŠ¸ëŠ” ë³´í˜¸ë¨ - ê±´ë„ˆëœ€`);
        return;
      }
      
      console.log(`${sheetName} ì‹œíŠ¸ ë¹ˆ í–‰ ì •ë¦¬ ì¤‘`);
      
      const maxRows = sheet.getMaxRows();
      const lastRow = sheet.getLastRow();
      
      if (lastRow < maxRows) {
        const rowsToDelete = maxRows - lastRow;
        console.log(`${sheetName}: ${rowsToDelete}ê°œ ë¹ˆ í–‰ ë°œê²¬`);
        
        if (rowsToDelete > 0) {
          sheet.deleteRows(lastRow + 1, rowsToDelete);
          totalRemoved += rowsToDelete;
          console.log(`${sheetName}: ${rowsToDelete}ê°œ í–‰ ì‚­ì œ ì™„ë£Œ`);
        }
      }
    } catch (error) {
      console.error(`ë¹ˆ í–‰ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜: ${error.toString()}`);
    }
  });
  
  ui.alert(`ì´ ${totalRemoved}ê°œì˜ ë¹ˆ í–‰ì´ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
}

// ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ í•¨ìˆ˜
function uploadExcelFile(base64Data, sheetName) {
  try {
    console.log(`ì—‘ì…€ ì—…ë¡œë“œ ì‹œì‘: ${sheetName}`);
    
    // Base64 ë””ì½”ë“œ
    const blob = Utilities.newBlob(
      Utilities.base64Decode(base64Data), 
      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 
      sheetName + '.xlsx'
    );
    
    // ì„ì‹œ íŒŒì¼ë¡œ ì €ì¥
    const tempFile = DriveApp.createFile(blob);
    const tempFileId = tempFile.getId();
    
    try {
      // ì—‘ì…€ íŒŒì¼ì„ Google Sheetsë¡œ ë³€í™˜
      const resource = {
        title: sheetName,
        mimeType: MimeType.GOOGLE_SHEETS,
        parents: [{id: 'root'}]
      };
      
      const convertedFile = Drive.Files.copy(resource, tempFileId);
      const convertedFileId = convertedFile.id;
      
      // ë³€í™˜ëœ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—´ê¸°
      const sourceSpreadsheet = SpreadsheetApp.openById(convertedFileId);
      const sourceSheet = sourceSpreadsheet.getSheets()[0];
      const sourceData = sourceSheet.getDataRange().getValues();
      
      // í˜„ì¬ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ì‹œíŠ¸ ìƒì„±
      const ss = SpreadsheetApp.getActiveSpreadsheet();
      let targetSheet = ss.getSheetByName(sheetName);
      
      if (!targetSheet) {
        targetSheet = ss.insertSheet(sheetName);
      } else {
        targetSheet.clear();
      }
      
      // ë°ì´í„° ë³µì‚¬
      if (sourceData.length > 0) {
        const targetRange = targetSheet.getRange(1, 1, sourceData.length, sourceData[0].length);
        targetRange.setValues(sourceData);
        
        // ê·¼ë¬´ì¼ ì—´ ì°¾ì•„ì„œ ì„œì‹ë§Œ ë³€ê²½
        const headers = sourceData[0];
        headers.forEach((header, index) => {
          if (header.toString().includes('ê·¼ë¬´ì¼')) {
            const workDateRange = targetSheet.getRange(2, index + 1, sourceData.length - 1, 1);
            workDateRange.setNumberFormat('yyyy-MM-dd');
            console.log(`ê·¼ë¬´ì¼ ì—´(${index + 1}ë²ˆì§¸) ì„œì‹ ì ìš© ì™„ë£Œ`);
          }
        });
      }
      
      // ì„ì‹œ íŒŒì¼ ì‚­ì œ
      DriveApp.getFileById(tempFileId).setTrashed(true);
      DriveApp.getFileById(convertedFileId).setTrashed(true);
      
      return {
        success: true,
        message: `${sheetName} ì‹œíŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`
      };
      
    } catch (error) {
      try {
        DriveApp.getFileById(tempFileId).setTrashed(true);
      } catch (e) {}
      throw error;
    }
    
  } catch (error) {
    console.error(`ì—‘ì…€ ì—…ë¡œë“œ ì˜¤ë¥˜: ${error.toString()}`);
    throw new Error(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.toString()}`);
  }
}

// ì„ íƒ ì‹œíŠ¸ ë°ì´í„° ì‚­ì œ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
function showDeleteSheetsDialog() {
  const html = HtmlService.createHtmlOutputFromFile('delete-sheets')
      .setWidth(650)
      .setHeight(600);
  SpreadsheetApp.getUi()
      .showModalDialog(html, 'ì‹œíŠ¸ ë°ì´í„° ì‚­ì œ');
}

// ì—‘ì…€ ì—…ë¡œë” í‘œì‹œ
function showExcelUploader() {
  const html = HtmlService.createHtmlOutputFromFile('uploader')
      .setWidth(850)
      .setHeight(700);
  SpreadsheetApp.getUi()
      .showModalDialog(html, 'ì—‘ì…€ íŒŒì¼ ì—…ë¡œë”');
}

// ë„ì›€ë§ í•¨ìˆ˜
function showHelp() {
  const helpText = `
ì—°ì¥ê·¼ë¬´ ì›”ë§ ë¹„êµë¶„ì„ ë„ì›€ë§

1. ë¹„êµë¶„ì„ ì‹¤ì‹œ: 
   - í˜„ì¬ ë‚ ì§œì™€ ê°€ì¥ ê°€ê¹Œìš´ ì‹œíŠ¸ë¥¼ ìë™ìœ¼ë¡œ ì°¾ìŠµë‹ˆë‹¤
   - í•´ë‹¹ ì‹œíŠ¸ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì „ì›”, ì‘ë…„ ë™ì›” ì‹œíŠ¸ë¥¼ ìë™ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤
   - ì¶•ì‚°ê³¼ ìƒìˆ˜ ì‹œíŠ¸ë¥¼ ê°ê° êµ¬ë¶„í•˜ì—¬ ì²˜ë¦¬í•©ë‹ˆë‹¤
   - ì´ ì •ë¦¬ í‘œë¥¼ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤

2. ì‹œíŠ¸ ì„ íƒí•˜ì—¬ ë¶„ì„: 
   - ì›í•˜ëŠ” ì‹œíŠ¸ë¥¼ ì„ íƒí•˜ì—¬ ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤

3. ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸:
   - ì´ ì •ë¦¬ í‘œë§Œ ë³„ë„ë¡œ ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤

4. ë¶„ì„ ê²°ê³¼:
   - "ì¶•ì‚° ì›”ë§ ë§ˆê° ë¦¬í¬íŠ¸" ì‹œíŠ¸ì— ì¶•ì‚° ë¶„ì„ ê²°ê³¼ ìƒì„±
   - "ìƒìˆ˜ ì›”ë§ ë§ˆê° ë¦¬í¬íŠ¸" ì‹œíŠ¸ì— ìƒìˆ˜ ë¶„ì„ ê²°ê³¼ ìƒì„±
   - "ì´ ì •ë¦¬ í‘œ" ì‹œíŠ¸ì— ì „ì²´ ìš”ì•½ ë°ì´í„° ì—…ë°ì´íŠ¸

ì£¼ì˜ì‚¬í•­:
- ì‹œíŠ¸ ì´ë¦„ì€ "YYYYë…„ Mì›” (ì¶•ì‚°)" ë˜ëŠ” "YYYYë…„ Mì›” (ìƒìˆ˜)" í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤
- ìµœì†Œ 2ê°œ ì´ìƒì˜ ì‹œíŠ¸ê°€ ìˆì–´ì•¼ ë¹„êµ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤
- ë¶„ì„ ì™„ë£Œ í›„ ì›ë³¸ ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ ì •ë¦¬ë©ë‹ˆë‹¤
- ì´ ì •ë¦¬ í‘œëŠ” ë°ì´í„° ì‚­ì œ ì‹œ ë³´í˜¸ë©ë‹ˆë‹¤
`;
  
  SpreadsheetApp.getUi().alert('ë„ì›€ë§', helpText, SpreadsheetApp.getUi().ButtonSet.OK);
}

// ë©”ë‰´ì—ì„œ ì‹œíŠ¸ ì •ë³´ í™•ì¸
function showDebugSheetInfo() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.prompt(
    'ì‹œíŠ¸ ì •ë³´ í™•ì¸',
    'í™•ì¸í•  ì‹œíŠ¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:',
    ui.ButtonSet.OK_CANCEL
  );
  
  if (response.getSelectedButton() === ui.Button.OK) {
    const sheetName = response.getResponseText();
    if (sheetName) {
      debugSheetInfo(sheetName);
      ui.alert('ì‹œíŠ¸ ì •ë³´ê°€ ë¡œê·¸ì— ì¶œë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n\ní™•ì¸ ë°©ë²•:\n1. í™•ì¥ í”„ë¡œê·¸ë¨ > Apps Script\n2. ì‹¤í–‰ > ë¡œê·¸ ë³´ê¸° (Ctrl+Enter)');
    }
  }
}

// ë””ë²„ê¹…ìš© ì‹œíŠ¸ ì •ë³´ ì¶œë ¥
function debugSheetInfo(sheetName) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(sheetName);
  
  if (!sheet) {
    console.log(`ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${sheetName}`);
    return;
  }
  
  console.log(`\n=== ${sheetName} ì‹œíŠ¸ ì •ë³´ ===`);
  console.log(`ìµœëŒ€ í–‰: ${sheet.getMaxRows()}`);
  console.log(`ìµœëŒ€ ì—´: ${sheet.getMaxColumns()}`);
  console.log(`ë§ˆì§€ë§‰ í–‰: ${sheet.getLastRow()}`);
  console.log(`ë§ˆì§€ë§‰ ì—´: ${sheet.getLastColumn()}`);
  
  // ìƒ˜í”Œ ë°ì´í„° ì¶œë ¥
  try {
    const sampleRange = sheet.getRange(1, 1, Math.min(5, sheet.getLastRow()), Math.min(10, sheet.getLastColumn()));
    const sampleData = sampleRange.getValues();
    console.log('ìƒ˜í”Œ ë°ì´í„° (ì²˜ìŒ 5í–‰ x 10ì—´):');
    sampleData.forEach((row, index) => {
      console.log(`í–‰ ${index + 1}: ${JSON.stringify(row)}`);
    });
  } catch (error) {
    console.error('ìƒ˜í”Œ ë°ì´í„° ì½ê¸° ì‹¤íŒ¨:', error.toString());
  }
}

// í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ - ì „ì²´ ê³¼ì • í…ŒìŠ¤íŠ¸
function testFullProcess() {
  testFullMonthlyClosingProcess();
}

// ========== ì´ ì •ë¦¬ í‘œ ê´€ë ¨ í•¨ìˆ˜ (ê°œì„  ë²„ì „) ==========

// ë©”ë‰´ì—ì„œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜ (ëˆ„ë½ë˜ì—ˆë˜ í•¨ìˆ˜)
function updateSummaryTableOnly() {
  console.log('\n' + '='.repeat(60));
  console.log('ğŸ“Š ===== ì´ ì •ë¦¬ í‘œ ë‹¨ë… ì—…ë°ì´íŠ¸ ì‹œì‘ =====');
  console.log('='.repeat(60));
  
  const ui = SpreadsheetApp.getUi();
  
  // ì‚¬ìš©ìì—ê²Œ ì—…ë°ì´íŠ¸ ë°©ë²• ì„ íƒ ì œê³µ
  const result = ui.alert(
    'ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸',
    'ì—…ë°ì´íŠ¸ ë°©ë²•ì„ ì„ íƒí•˜ì„¸ìš”:\n\n' +
    '[ì˜ˆ] - ê¸°ì¡´ ì‹œíŠ¸ì˜ ì§‘ê³„í‘œì—ì„œ ë°ì´í„° ì¶”ì¶œ\n' +
    '[ì•„ë‹ˆì˜¤] - ì‹œíŠ¸ ì¬ì²˜ë¦¬ í›„ ì—…ë°ì´íŠ¸\n' +
    '[ì·¨ì†Œ] - ì‘ì—… ì·¨ì†Œ',
    ui.ButtonSet.YES_NO_CANCEL
  );
  
  if (result === ui.Button.YES) {
    // ê¸°ì¡´ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ì¶”ì¶œ
    updateSummaryTableFromSheets();
  } else if (result === ui.Button.NO) {
    // ì‹œíŠ¸ ì¬ì²˜ë¦¬ í›„ ì—…ë°ì´íŠ¸
    reprocessAndUpdateSummaryTable();
  } else {
    console.log('ì‚¬ìš©ìê°€ ì·¨ì†Œí•¨');
  }
}

// ì‹œíŠ¸ ì¬ì²˜ë¦¬ í›„ ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸
function reprocessAndUpdateSummaryTable() {
  console.log('\n' + '='.repeat(60));
  console.log('ğŸ”„ ===== ì‹œíŠ¸ ì¬ì²˜ë¦¬ í›„ ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸ =====');
  console.log('='.repeat(60));
  
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const summarySheet = ss.getSheetByName('ì´ ì •ë¦¬ í‘œ');
  
  if (!summarySheet) {
    SpreadsheetApp.getUi().alert('ì´ ì •ë¦¬ í‘œ ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  // 3í–‰ì˜ í—¤ë” ì½ê¸°
  const headers = summarySheet.getRange(3, 2, 1, 3).getValues()[0];
  console.log('\nğŸ“‹ ì´ ì •ë¦¬ í‘œ í—¤ë”:');
  headers.forEach((h, i) => {
    console.log(`  ${String.fromCharCode(66 + i)}3: "${h}"`);
  });
  
  // í—¤ë” íŒŒì‹±
  const headerInfo = parseHeadersImproved(headers);
  
  // ì²˜ë¦¬í•  ì‹œíŠ¸ ì°¾ê¸°
  const sheetsToProcess = findSheetsForHeaders(ss, headerInfo);
  
  if (sheetsToProcess.length === 0) {
    SpreadsheetApp.getUi().alert('ì²˜ë¦¬í•  ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  console.log('\nğŸ“„ ì²˜ë¦¬í•  ì‹œíŠ¸:');
  sheetsToProcess.forEach(s => console.log(`  - ${s.name}`));
  
  // ì‹œíŠ¸ ì²˜ë¦¬
  const processedData = {};
  sheetsToProcess.forEach(sheetInfo => {
    try {
      console.log(`\nì²˜ë¦¬ ì¤‘: ${sheetInfo.name}`);
      const sheet = ss.getSheetByName(sheetInfo.name);
      if (sheet) {
        processedData[sheetInfo.name] = processSheet(sheet);
      }
    } catch (error) {
      console.error(`${sheetInfo.name} ì²˜ë¦¬ ì‹¤íŒ¨: ${error.toString()}`);
    }
  });
  
  // ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸
  updateSummaryTable(processedData);
  
  SpreadsheetApp.getUi().alert('ì´ ì •ë¦¬ í‘œ ì—…ë°ì´íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// ê°œì„ ëœ í—¤ë” íŒŒì‹± í•¨ìˆ˜
function parseHeadersImproved(headers) {
  const headerInfo = [];
  const currentDate = new Date();
  const currentYear = currentDate.getFullYear();
  
  headers.forEach((header, index) => {
    if (!header) {
      headerInfo.push(null);
      return;
    }
    
    const headerStr = header.toString().trim();
    console.log(`\n  í—¤ë” íŒŒì‹± ì¤‘: "${headerStr}"`);
    
    let parsed = null;
    
    // ë‹¤ì–‘í•œ í˜•ì‹ ì²˜ë¦¬
    // "7ì›”" í˜•ì‹
    if (headerStr.match(/^(\d{1,2})ì›”$/)) {
      const month = parseInt(RegExp.$1);
      // í˜„ì¬ ì›”ë³´ë‹¤ í¬ë©´ ì‘ë…„ìœ¼ë¡œ íŒë‹¨
      const year = month > currentDate.getMonth() + 1 ? currentYear - 1 : currentYear;
      parsed = { year: year, month: month, original: headerStr };
      console.log(`    â†’ ${year}ë…„ ${month}ì›”ë¡œ íŒŒì‹± (ë‹¨ìˆœ ì›”)}`);
    }
    // "24ë…„ 7ì›”" í˜•ì‹
    else if (headerStr.match(/^(\d{2})ë…„\s*(\d{1,2})ì›”$/)) {
      const yearPart = parseInt(RegExp.$1);
      const month = parseInt(RegExp.$2);
      // 2000ë…„ëŒ€ë¡œ ê°€ì •
      const year = yearPart < 50 ? 2000 + yearPart : 1900 + yearPart;
      parsed = { year: year, month: month, original: headerStr };
      console.log(`    â†’ ${year}ë…„ ${month}ì›”ë¡œ íŒŒì‹± (2ìë¦¬ ì—°ë„)`);
    }
    // "2024ë…„ 7ì›”" í˜•ì‹
    else if (headerStr.match(/^(\d{4})ë…„\s*(\d{1,2})ì›”$/)) {
      const year = parseInt(RegExp.$1);
      const month = parseInt(RegExp.$2);
      parsed = { year: year, month: month, original: headerStr };
      console.log(`    â†’ ${year}ë…„ ${month}ì›”ë¡œ íŒŒì‹± (4ìë¦¬ ì—°ë„)`);
    }
    // "2024.7" ë˜ëŠ” "2024/7" í˜•ì‹
    else if (headerStr.match(/^(\d{4})[.\/](\d{1,2})$/)) {
      const year = parseInt(RegExp.$1);
      const month = parseInt(RegExp.$2);
      parsed = { year: year, month: month, original: headerStr };
      console.log(`    â†’ ${year}ë…„ ${month}ì›”ë¡œ íŒŒì‹± (êµ¬ë¶„ì í˜•ì‹)`);
    }
    else {
      console.log(`    â†’ íŒŒì‹± ì‹¤íŒ¨`);
    }
    
    headerInfo.push(parsed);
  });
  
  return headerInfo;
}

// í—¤ë”ì— ë§ëŠ” ì‹œíŠ¸ ì°¾ê¸°
function findSheetsForHeaders(ss, headerInfo) {
  const sheets = [];
  const allSheets = ss.getSheets();
  
  headerInfo.forEach(header => {
    if (!header) return;
    
    // ì¶•ì‚°ê³¼ ìƒìˆ˜ ì‹œíŠ¸ ëª¨ë‘ ì°¾ê¸°
    ['ì¶•ì‚°', 'ìƒìˆ˜'].forEach(type => {
      const sheetName = `${header.year}ë…„ ${header.month}ì›” (${type})`;
      const sheet = allSheets.find(s => {
        const name = s.getName();
        // ì •í™•í•œ ë§¤ì¹­ ë˜ëŠ” ê³µë°± ì°¨ì´ í—ˆìš©
        return name === sheetName || 
               name.replace(/\s+/g, '') === sheetName.replace(/\s+/g, '');
      });
      
      if (sheet) {
        sheets.push({
          name: sheet.getName(),
          year: header.year,
          month: header.month,
          type: type
        });
      }
    });
  });
  
  return sheets;
}



// ë‚ ì§œ í˜•ì‹ ê´€ë ¨ í•¨ìˆ˜ë“¤ì€ í•„ìš”í•œ ê²½ìš° ì¶”ê°€...
