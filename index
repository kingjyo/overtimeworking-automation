<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: 'Malgun Gothic', sans-serif;
        padding: 20px;
        background-color: #f5f5f5;
      }
      
      .container {
        max-width: 600px;
        margin: 0 auto;
        background-color: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
        font-size: 24px;
      }
      
      .section {
        margin-bottom: 25px;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border: 1px solid #e9ecef;
      }
      
      .section-title {
        font-weight: bold;
        color: #495057;
        margin-bottom: 15px;
        font-size: 16px;
      }
      
      .sheet-group {
        display: flex;
        flex-direction: row;
        gap: 50px;
        justify-content: center;
        align-items: flex-start;
        margin-bottom: 20px;
      }

      .sheet-column {
        display: flex;
        flex-direction: column;
        gap: 14px;
        min-width: 220px;
      }
      .sheet-item {
        margin-bottom: 10px;
        display: flex;
        align-items: center;
      }

      
      input[type="checkbox"] {
        margin-right: 10px;
        width: 18px;
        height: 18px;
        cursor: pointer;
      }
      
      label {
        cursor: pointer;
        font-size: 14px;
        color: #333
        white-space: nowrap;
      }
      
      .button-container {
        text-align: center;
        margin-top: 30px;
      }
      
      button {
        background-color: #4285f4;
        color: white;
        border: none;
        padding: 12px 30px;
        font-size: 16px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s;
      }
      
      button:hover {
        background-color: #357ae8;
      }
      
      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      
      .status-message {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
        text-align: center;
        display: none;
      }
      
      .status-message.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      
      .status-message.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      
      .status-message.info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      
      .progress {
        width: 100%;
        height: 20px;
        background-color: #e9ecef;
        border-radius: 10px;
        margin-top: 20px;
        overflow: hidden;
        display: none;
      }
      
      .progress-bar {
        height: 100%;
        background-color: #4285f4;
        width: 0%;
        transition: width 0.3s ease;
        border-radius: 10px;
      }
      
      .preset-buttons {
        margin-top: 15px;
        display: flex;
        gap: 10px;
        justify-content: center;
      }
      
      .preset-button {
        background-color: #6c757d;
        color: white;
        border: none;
        padding: 8px 16px;
        font-size: 14px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      
      .preset-button:hover {
        background-color: #5a6268;
      }
      
      .info-text {
        font-size: 12px;
        color: #6c757d;
        margin-top: 10px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>연장근무 월말 비교분석</h1>
      
      <div class="section">
        <div class="section-title">분석할 시트 선택</div>
        
        <div class="sheet-group">
          <div class="sheet-column">
            <div class="sheet-item">
              <input type="checkbox" id="sheet1" value="2025년 6월 (축산)" checked>
              <label for="sheet1">2025년 6월 (축산)</label>
            </div>
          <div class="sheet-item">
            <input type="checkbox" id="sheet2" value="2025년 5월 (축산)" checked>
            <label for="sheet2">2025년 5월 (축산)</label>
          </div>
          <div class="sheet-item">
            <input type="checkbox" id="sheet3" value="2024년 6월 (축산)" checked>
            <label for="sheet3">2024년 6월 (축산)</label>
          </div>
        </div>
          <div class="sheet-column">
            <div class="sheet-item">
             <input type="checkbox" id="sheet4" value="2025년 6월 (생수)" checked>
             <label for="sheet4">2025년 6월 (생수)</label>
          </div>
          <div class="sheet-item">
            <input type="checkbox" id="sheet5" value="2025년 5월 (생수)" checked>
            <label for="sheet5">2025년 5월 (생수)</label>
          </div>
          <div class="sheet-item">
            <input type="checkbox" id="sheet6" value="2024년 6월 (생수)" checked>
            <label for="sheet6">2024년 6월 (생수)</label>
          </div>
        </div>
      </div>
        <div class="preset-buttons">
          <button class="preset-button" onclick="selectAll()">전체 선택</button>
          <button class="preset-button" onclick="deselectAll()">전체 해제</button>
          <button class="preset-button" onclick="selectRecent()">최근 3개월</button>
        </div>
      </div>
      
      <div class="info-text">
        * 비교분석을 위해서는 최소 2개 이상의 시트를 선택해야 합니다.<br>
        * 전월 대비 및 전년 동월 대비 분석이 자동으로 수행됩니다.
      </div>
      
      <div class="button-container">
        <button id="analyzeButton" onclick="runAnalysis()">비교분석 실시</button>
      </div>
      
      <div class="progress" id="progressBar">
        <div class="progress-bar" id="progressBarFill"></div>
      </div>
      
      <div class="status-message" id="statusMessage"></div>
    </div>
    
    <script>
      function getSelectedSheets() {
        const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
        return Array.from(checkboxes).map(cb => cb.value);
      }
      
      function selectAll() {
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
      }
      
      function deselectAll() {
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      }
      
      function selectRecent() {
        // 최근 3개월 선택 로직 (예시)
        deselectAll();
        document.getElementById('sheet1').checked = true;
        document.getElementById('sheet2').checked = true;
        document.getElementById('sheet3').checked = true;
        document.getElementById('sheet4').checked = true;
        document.getElementById('sheet5').checked = true;
        document.getElementById('sheet6').checked = true;
      }
      
      function showMessage(message, type) {
        const statusDiv = document.getElementById('statusMessage');
        statusDiv.textContent = message;
        statusDiv.className = 'status-message ' + type;
        statusDiv.style.display = 'block';
      }
      
      function updateProgress(percent) {
        document.getElementById('progressBar').style.display = 'block';
        document.getElementById('progressBarFill').style.width = percent + '%';
      }
      
      function runAnalysis() {
        const selectedSheets = getSelectedSheets();
        
        if (selectedSheets.length < 2) {
          showMessage('최소 2개 이상의 시트를 선택해주세요.', 'error');
          return;
        }
        
        // 버튼 비활성화
        document.getElementById('analyzeButton').disabled = true;
        
        // 진행 상태 표시
        showMessage('분석을 시작합니다...', 'info');
        updateProgress(0);
        
        // 진행 상황 체크 시작
        startStatusPolling();
        
        // Google Apps Script 함수 호출
        google.script.run
          .withSuccessHandler(onSuccess)
          .withFailureHandler(onFailure)
          .runAnalysisWithSheets(selectedSheets);
      }
      
      let statusInterval;
      
      function startStatusPolling() {
        // 0.5초마다 상태 확인
        statusInterval = setInterval(() => {
          google.script.run
            .withSuccessHandler((status) => {
              if (status && status.message) {
                showMessage(status.message, 'info');
                if (status.progress !== null) {
                  updateProgress(status.progress);
                }
              }
            })
            .getAnalysisStatus();
        }, 500);
      }
      
      function stopStatusPolling() {
        if (statusInterval) {
          clearInterval(statusInterval);
          statusInterval = null;
        }
      }
      
      function onSuccess(result) {
        stopStatusPolling();
        updateProgress(100);
        showMessage('비교분석이 완료되었습니다! "월말 마감 리포트" 시트를 확인해주세요.', 'success');
        document.getElementById('analyzeButton').disabled = false;
        
        // 3초 후 창 닫기
        setTimeout(() => {
          google.script.host.close();
        }, 3000);
      }
      
      function onFailure(error) {
        stopStatusPolling();
        showMessage('오류가 발생했습니다: ' + error.message, 'error');
        document.getElementById('analyzeButton').disabled = false;
        document.getElementById('progressBar').style.display = 'none';
      }
      
      // 진행 상황 업데이트를 위한 함수 (서버에서 호출)
      function updateStatus(message, progress) {
        showMessage(message, 'info');
        updateProgress(progress);
      }
    </script>
  </body>
</html>
