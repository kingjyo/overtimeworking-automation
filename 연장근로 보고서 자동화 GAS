// ì œì£¼ì‚¬ì—…ë¶€ ì—°ì¥ê·¼ë¡œ ë³´ê³ ì„œ ìë™í™” ìŠ¤í¬ë¦½íŠ¸

// ì„¤ì •ê°’
const CONFIG = {
  SPREADSHEET_ID: '1cLzzp3bJjsc4f8tbQUoYeakeDhxodyuLQ48DucYEIdo', // ë¹„êµë¶„ì„ ì‹œìŠ¤í…œ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID
  TEMPLATE_DOC_ID: '1W52lxo5T1I7Y_i89lWGx4omnluN18yVhQPdlvWZ8vKg', // í…œí”Œë¦¿ ë¬¸ì„œ ID
  OUTPUT_FOLDER_ID: '18sjRrqSgtBQSWMy_GNfkng3ljnY0kKcE', // ìƒì„±ëœ ë¬¸ì„œë¥¼ ì €ì¥í•  í´ë” ID
  SHEET_NAME: 'ì´ ì •ë¦¬ í‘œ'
};

// ë©”ì¸ í•¨ìˆ˜: ì—°ì¥ê·¼ë¡œ ë³´ê³ ì„œ ìƒì„±
function generateOvertimeReport() {
  try {
    // ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const spreadsheet = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
    const sheet = spreadsheet.getSheetByName(CONFIG.SHEET_NAME);
    
    if (!sheet) {
      throw new Error('ì´ ì •ë¦¬ í‘œ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
    
    // í•„ìš”í•œ ë°ì´í„° ì¶”ì¶œ
    const data = extractData(sheet);
    
    // í…œí”Œë¦¿ ë³µì‚¬
    const templateDoc = DriveApp.getFileById(CONFIG.TEMPLATE_DOC_ID);
    const folder = DriveApp.getFolderById(CONFIG.OUTPUT_FOLDER_ID);
    const fileName = `ì œì£¼ì‚¬ì—…ë¶€ ì—°ì¥ê·¼ë¡œ ${data.year}ë…„ ${data.currentMonth}ì›” ì‹¤ì  ë° ${data.nextMonth}ì›” ê³„íš í†µë³´`;
    const newDoc = templateDoc.makeCopy(fileName, folder);
    
    // ë¬¸ì„œ ì—´ê¸° ë° ë°ì´í„° ì…ë ¥
    const doc = DocumentApp.openById(newDoc.getId());
    const body = doc.getBody();
    
    // ë°ì´í„° ì¹˜í™˜
    replaceData(body, data);
    
    // ë¬¸ì„œ ì €ì¥
    doc.saveAndClose();
    
    // ì„±ê³µ ë©”ì‹œì§€ ë° ë§í¬ í‘œì‹œ
    const docUrl = newDoc.getUrl();
    const htmlOutput = HtmlService.createHtmlOutput(`
      <div style="padding: 20px; font-family: 'Noto Sans KR', sans-serif;">
        <h3 style="color: #1a73e8;">âœ… ë³´ê³ ì„œ ìƒì„± ì™„ë£Œ!</h3>
        <p>ì—°ì¥ê·¼ë¡œ ë³´ê³ ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        <p><strong>ë¬¸ì„œëª…:</strong> ${fileName}</p>
        <p><a href="${docUrl}" target="_blank" style="display: inline-block; margin-top: 10px; padding: 10px 20px; background-color: #1a73e8; color: white; text-decoration: none; border-radius: 5px;">ğŸ“„ ë¬¸ì„œ ì—´ê¸°</a></p>
      </div>
    `)
    .setWidth(400)
    .setHeight(200);
    
    SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'ë³´ê³ ì„œ ìƒì„± ì™„ë£Œ');
    
  } catch (error) {
    SpreadsheetApp.getUi().alert('âŒ ì˜¤ë¥˜ ë°œìƒ: ' + error.toString());
  }
}

// ë°ì´í„° ì¶”ì¶œ í•¨ìˆ˜
function extractData(sheet) {
  const data = {};
  
  // ê¸°ë³¸ ë‚ ì§œ ì •ë³´
  data.year = sheet.getRange('D1').getValue(); // ê¸°ì¤€ ë…„ë„
  data.currentMonth = sheet.getRange('F1').getValue(); // ê¸°ì¤€ ì›”
  data.nextMonth = parseInt(data.currentMonth) + 1; // ë‹¤ìŒ ì›”
  if (data.nextMonth > 12) {
    data.nextMonth = 1;
  }
  
  // ì´ ì—°ì¥ê·¼ë¡œ ì‹œê°„
  data.totalHours = sheet.getRange('B6').getValue();
  
  // ì—°ì¥ê·¼ë¡œ ì‹¤ì  í‘œ (B4:F6)
  data.overtimeTable = sheet.getRange('B4:F6').getValues();
  
  // ì œë™ëª©ì¥ ì¦ê° ê³„ì‚°
  const jedongCurrent = sheet.getRange('B4').getValue();
  const jedongPrevMonth = sheet.getRange('C4').getValue();
  const jedongPrevYear = sheet.getRange('D4').getValue();
  
  data.jedongMonthDiff = Math.abs(jedongCurrent - jedongPrevMonth);
  data.jedongMonthTrend = jedongCurrent > jedongPrevMonth ? 'ì¦ê°€' : 'ê°ì†Œ';
  
  data.jedongYearDiff = Math.abs(jedongCurrent - jedongPrevYear);
  data.jedongYearTrend = jedongCurrent > jedongPrevYear ? 'ì¦ê°€' : 'ê°ì†Œ';
  
  // ìƒìˆ˜ê³µì¥ ì¦ê° ê³„ì‚°
  const waterCurrent = sheet.getRange('B5').getValue();
  const waterPrevMonth = sheet.getRange('C5').getValue();
  const waterPrevYear = sheet.getRange('D5').getValue();
  
  data.waterMonthDiff = Math.abs(waterCurrent - waterPrevMonth);
  data.waterMonthTrend = waterCurrent > waterPrevMonth ? 'ì¦ê°€' : 'ê°ì†Œ';
  
  data.waterYearDiff = Math.abs(waterCurrent - waterPrevYear);
  data.waterYearTrend = waterCurrent > waterPrevYear ? 'ì¦ê°€' : 'ê°ì†Œ';
  
  // ìƒìˆ˜ê³µì¥ ì—°ì¥ê·¼ë¡œ ì¦ê°ë‚´ì—­ í‘œ (C10:G19)
  data.waterProductionTable = sheet.getRange('C10:G19').getValues();
  
  // ë‹¤ìŒ ì›” ê³„íš í‘œ (K12:R14)
  data.nextMonthPlanTable = sheet.getRange('K12:R14').getValues();
  
  // ì¶”ê°€ ê³„íš ì •ë³´
  data.birthPlanHeads = sheet.getRange('O12').getValue(); // ë¶„ë§Œ ê³„íš ë‘ìˆ˜
  const jedongPlanCurrent = sheet.getRange('M12').getValue();
  const jedongPlanPrev = sheet.getRange('K12').getValue();
  data.jedongPlanTrend = jedongPlanCurrent > jedongPlanPrev ? 'ì¦ê°€' : 'ê°ì†Œ';
  
  data.waterProductionDiff = sheet.getRange('O13').getValue(); // ìƒì‚°ëŸ‰ ì°¨ì´
  const waterPlanCurrent = sheet.getRange('M13').getValue();
  const waterPlanPrev = sheet.getRange('K13').getValue();
  data.waterPlanTrend = waterPlanCurrent > waterPlanPrev ? 'ì¦ê°€' : 'ê°ì†Œ';
  
  return data;
}

// ë°ì´í„° ì¹˜í™˜ í•¨ìˆ˜
function replaceData(body, data) {
  let text = body.getText();
  
  // ì œëª© ë¶€ë¶„ ì¹˜í™˜
  text = text.replace(/2025ë…„ \( \)ì›” ì œì£¼ì‚¬ì—…ë¶€ ì—°ì¥ê·¼ë¡œ ì‹¤ì  ë° \( \)ì›” ê³„íš/, 
    `2025ë…„ ${data.currentMonth}ì›” ì œì£¼ì‚¬ì—…ë¶€ ì—°ì¥ê·¼ë¡œ ì‹¤ì  ë° ${data.nextMonth}ì›” ê³„íš`);
  
  // 1. ì—°ì¥ê·¼ë¡œ ì‹¤ì 
  text = text.replace(/\*\*1\. \( \)ì›” ì—°ì¥ê·¼ë¡œ ì‹¤ì  : \( \)ì‹œê°„\*\*/, 
    `**1. ${data.currentMonth}ì›” ì—°ì¥ê·¼ë¡œ ì‹¤ì  : ${data.totalHours}ì‹œê°„**`);
  
  // ì œë™ëª©ì¥ ì¦ê°ë‚´ì—­
  text = text.replace(/1\) ì „ì›” ëŒ€ë¹„ : \( \)ì‹œê°„ \( \)/, 
    `1) ì „ì›” ëŒ€ë¹„ : ${data.jedongMonthDiff}ì‹œê°„ ${data.jedongMonthTrend}`);
  
  text = text.replace(/2\) ì „ë…„ ëŒ€ë¹„ : \( \)ì‹œê°„ \( \)/, 
    `2) ì „ë…„ ëŒ€ë¹„ : ${data.jedongYearDiff}ì‹œê°„ ${data.jedongYearTrend}`);
  
  // ìƒìˆ˜ê³µì¥ ì¦ê°ë‚´ì—­
  const waterMonthText = `1) ì „ì›” ëŒ€ë¹„ : ${data.waterMonthDiff}ì‹œê°„ ${data.waterMonthTrend}`;
  const waterYearText = `2) ì „ë…„ ëŒ€ë¹„ : ${data.waterYearDiff}ì‹œê°„ ${data.waterYearTrend}`;
  
  // í…ìŠ¤íŠ¸ ì¹˜í™˜ ëŒ€ì‹  ì§ì ‘ ì°¾ì•„ì„œ ë°”ê¾¸ê¸°
  body.replaceText('1\\) ì „ì›” ëŒ€ë¹„ : \\( \\)ì‹œê°„ \\( \\)', waterMonthText);
  body.replaceText('2\\) ì „ë…„ ëŒ€ë¹„ : \\( \\)ì‹œê°„ ì¦ê°€', waterYearText);
  
  // 2. ì—°ì¥ê·¼ë¡œ ê³„íš
  body.replaceText('\\*\\*2\\. 25ë…„ \\( \\)ì›” ì—°ì¥ê·¼ë¡œ ê³„íš\\*\\*', 
    `**2. 25ë…„ ${data.nextMonth}ì›” ì—°ì¥ê·¼ë¡œ ê³„íš**`);
  
  // ì œë™ëª©ì¥ ê³„íš
  body.replaceText('25ë…„ \\( \\)ì›” ì œë™ëª©ì¥ ì†¡ì•„ì§€ ë¶„ë§Œ ê³„íš ë‘ìˆ˜', 
    `25ë…„ ${data.nextMonth}ì›” ì œë™ëª©ì¥ ì†¡ì•„ì§€ ë¶„ë§Œ ê³„íš ë‘ìˆ˜`);
  
  body.replaceText('ì „ì›” ëŒ€ë¹„ ë¶„ë§Œ ë‘ìˆ˜ \\( \\)ë‘ \\( \\)ì— ë”°ë¥¸ ì—°ì¥ì‹œê°„ \\( \\) ì˜ˆìƒ', 
    `ì „ì›” ëŒ€ë¹„ ë¶„ë§Œ ë‘ìˆ˜ ${data.birthPlanHeads}ë‘ ${data.jedongPlanTrend}ì— ë”°ë¥¸ ì—°ì¥ì‹œê°„ ${data.jedongPlanTrend} ì˜ˆìƒ`);
  
  // ìƒìˆ˜ê³µì¥ ê³„íš
  body.replaceText('ì „ì›”ëŒ€ë¹„ ì œí’ˆ ìƒì‚°ëŸ‰ \\( \\)í†¤ \\( \\) ê³„íšìœ¼ë¡œ ì—°ì¥ ì‹œê°„ \\( \\) ì˜ˆìƒ', 
    `ì „ì›”ëŒ€ë¹„ ì œí’ˆ ìƒì‚°ëŸ‰ ${data.waterProductionDiff}í†¤ ${data.waterPlanTrend} ê³„íšìœ¼ë¡œ ì—°ì¥ ì‹œê°„ ${data.waterPlanTrend} ì˜ˆìƒ`);
  
  // ì²¨ë¶€
  body.replaceText('ì²¨ ë¶€ : 2025ë…„ \\( \\)ì›” ì œì£¼ì‚¬ì—…ë¶€ ì—°ì¥ê·¼ë¡œ í˜„í™©', 
    `ì²¨ ë¶€ : 2025ë…„ ${data.currentMonth}ì›” ì œì£¼ì‚¬ì—…ë¶€ ì—°ì¥ê·¼ë¡œ í˜„í™©`);
  
  // í‘œ ë°ì´í„° ì—…ë°ì´íŠ¸
  updateTables(body, data);
}

// í‘œ ë°ì´í„° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateTables(body, data) {
  const tables = body.getTables();
  
  if (tables.length >= 3) {
    // ì²« ë²ˆì§¸ í‘œ: ì—°ì¥ê·¼ë¡œ ì‹¤ì  í‘œ
    const overtimeTable = tables[0];
    for (let i = 0; i < 3; i++) {
      for (let j = 0; j < 5; j++) {
        const cellValue = data.overtimeTable[i][j];
        if (cellValue !== undefined && cellValue !== null && cellValue !== '') {
          overtimeTable.getCell(i + 1, j + 1).setText(String(cellValue));
        }
      }
    }
    
    // ë‘ ë²ˆì§¸ í‘œ: ìƒìˆ˜ê³µì¥ ì—°ì¥ê·¼ë¡œ ì¦ê°ë‚´ì—­ í‘œ
    const waterTable = tables[1];
    for (let i = 0; i < 10; i++) {
      for (let j = 0; j < 5; j++) {
        const cellValue = data.waterProductionTable[i][j];
        if (cellValue !== undefined && cellValue !== null && cellValue !== '') {
          waterTable.getCell(i + 1, j + 2).setText(String(cellValue));
        }
      }
    }
    
    // ì„¸ ë²ˆì§¸ í‘œ: ë‹¤ìŒ ì›” ê³„íš í‘œ
    const planTable = tables[2];
    for (let i = 0; i < 3; i++) {
      for (let j = 0; j < 8; j++) {
        const cellValue = data.nextMonthPlanTable[i][j];
        if (cellValue !== undefined && cellValue !== null && cellValue !== '') {
          planTable.getCell(i + 1, j + 1).setText(String(cellValue));
        }
      }
    }
  }
}

// ì„¤ì • í™”ë©´ í‘œì‹œ
function showSettings() {
  const htmlOutput = HtmlService.createHtmlOutput(`
    <div style="padding: 20px; font-family: 'Noto Sans KR', sans-serif;">
      <h3>âš™ï¸ í˜„ì¬ ì„¤ì •</h3>
      <p><strong>ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID:</strong><br>${CONFIG.SPREADSHEET_ID}</p>
      <p><strong>í…œí”Œë¦¿ ë¬¸ì„œ ID:</strong><br>${CONFIG.TEMPLATE_DOC_ID}</p>
      <p><strong>ì €ì¥ í´ë” ID:</strong><br>${CONFIG.OUTPUT_FOLDER_ID}</p>
      <hr>
      <p style="color: #666; font-size: 12px;">
        * ì„¤ì •ì„ ë³€ê²½í•˜ë ¤ë©´ ìŠ¤í¬ë¦½íŠ¸ í¸ì§‘ê¸°ì—ì„œ CONFIG ê°ì²´ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.
      </p>
    </div>
  `)
  .setWidth(400)
  .setHeight(300);
  
  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'ì„¤ì •');
}

// ìœ í‹¸ë¦¬í‹°: ìˆ«ì í¬ë§·íŒ…
function formatNumber(num) {
  if (typeof num === 'number') {
    return num.toFixed(2);
  }
  return num;
}

// í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
function testDataExtraction() {
  const spreadsheet = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
  const sheet = spreadsheet.getSheetByName(CONFIG.SHEET_NAME);
  const data = extractData(sheet);
  
  console.log('ì¶”ì¶œëœ ë°ì´í„°:', data);
}
